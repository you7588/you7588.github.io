<!DOCTYPE html>



  


<html class="theme-next muse use-motion" lang="zh-Hans">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />




  
  
  
  

  
    
    
  

  

  

  

  

  
    
    
    <link href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  






<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.2" rel="stylesheet" type="text/css" />


  <meta name="keywords" content="JS," />








  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=5.1.2" />






<meta name="description" content="介绍该开发教程是基于Node/Express的WebApp教程，旨在让初学者快速学习开发一个前端和后端一体的WebApp。 本教程希望学习者有一些JavaScript的基础。教程中会涉及到很多新的概念和开发模块，对于初学者来说，理解上会很难。但是这都没有关系，初学者只需要按照教程一步一步的去做，就一定会做到最后的结果。 达到结果后，再回过头去摸索教程中提到的所有概念。 下面罗列一些知识点，供你判定">
<meta name="keywords" content="JS">
<meta property="og:type" content="article">
<meta property="og:title" content="WeApp">
<meta property="og:url" content="http://yoursite.com/2017/11/18/WeApp/index.html">
<meta property="og:site_name" content="时间的朋友">
<meta property="og:description" content="介绍该开发教程是基于Node/Express的WebApp教程，旨在让初学者快速学习开发一个前端和后端一体的WebApp。 本教程希望学习者有一些JavaScript的基础。教程中会涉及到很多新的概念和开发模块，对于初学者来说，理解上会很难。但是这都没有关系，初学者只需要按照教程一步一步的去做，就一定会做到最后的结果。 达到结果后，再回过头去摸索教程中提到的所有概念。 下面罗列一些知识点，供你判定">
<meta property="og:locale" content="zh-Hans">
<meta property="og:image" content="https://ws2.sinaimg.cn/large/006tKfTcgy1flcwz9kmekj31fw1f0ai7.jpg">
<meta property="og:image" content="https://github.com/xugy0926/learn-webapp-guideline/raw/master/assets/render-1.png">
<meta property="og:image" content="https://github.com/xugy0926/learn-webapp-guideline/raw/master/assets/render-2.png">
<meta property="og:image" content="https://github.com/you7588/learn-webapp-guideline/raw/master/assets/pages-jump.png">
<meta property="og:image" content="https://github.com/xugy0926/learn-webapp-guideline/raw/master/assets/login.png">
<meta property="og:image" content="https://github.com/xugy0926/learn-webapp-guideline/raw/master/assets/request-cookie.png">
<meta property="og:image" content="https://github.com/you7588/learn-webapp-guideline/raw/master/assets/install-mongodb-1.png">
<meta property="og:image" content="https://github.com/you7588/learn-webapp-guideline/raw/master/assets/install-mongodb-2.png">
<meta property="og:image" content="https://github.com/you7588/learn-webapp-guideline/raw/master/assets/install-mongodb-4.png">
<meta property="og:image" content="https://github.com/you7588/learn-webapp-guideline/raw/master/assets/install-mongodb-5.png">
<meta property="og:updated_time" content="2017-11-19T03:54:15.000Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="WeApp">
<meta name="twitter:description" content="介绍该开发教程是基于Node/Express的WebApp教程，旨在让初学者快速学习开发一个前端和后端一体的WebApp。 本教程希望学习者有一些JavaScript的基础。教程中会涉及到很多新的概念和开发模块，对于初学者来说，理解上会很难。但是这都没有关系，初学者只需要按照教程一步一步的去做，就一定会做到最后的结果。 达到结果后，再回过头去摸索教程中提到的所有概念。 下面罗列一些知识点，供你判定">
<meta name="twitter:image" content="https://ws2.sinaimg.cn/large/006tKfTcgy1flcwz9kmekj31fw1f0ai7.jpg">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Muse',
    version: '5.1.2',
    sidebar: {"position":"left","display":"post","offset":12,"offset_float":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn"}},
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://yoursite.com/2017/11/18/WeApp/"/>





  <title>WeApp | 时间的朋友</title>
  




<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
            (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
          m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
  ga('create', '105782654', 'auto');
  ga('send', 'pageview');
</script>





</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">时间的朋友</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle">把琐碎的时间堆砌成一个伟大的生命。</p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            时间线
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br />
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            标签
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-user"></i> <br />
            
            关于
          </a>
        </li>
      
        
        <li class="menu-item menu-item-word">
          <a href="/word/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-heartbeat"></i> <br />
            
            博物馆
          </a>
        </li>
      
        
        <li class="menu-item menu-item-cheatsheet">
          <a href="/cheatsheet/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br />
            
            速查卡
          </a>
        </li>
      
        
        <li class="menu-item menu-item-feedback">
          <a href="/feedback/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-users"></i> <br />
            
            反馈
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2017/11/18/WeApp/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Katherine Chen">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="https://ws2.sinaimg.cn/large/006tKfTcly1fj5edaynjzj30hs0hsglv.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="时间的朋友">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">WeApp</h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-11-18T11:02:53+08:00">
                2017-11-18
              </time>
            

            

            
          </span>

          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2017/11/18/WeApp/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count"
                        data-disqus-identifier="2017/11/18/WeApp/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <h1 id="介绍"><a href="#介绍" class="headerlink" title="介绍"></a>介绍</h1><p>该开发教程是基于Node/Express的WebApp教程，旨在让初学者快速学习开发一个前端和后端一体的WebApp。</p>
<p>本教程希望学习者有一些JavaScript的基础。教程中会涉及到很多新的概念和开发模块，对于初学者来说，理解上会很难。但是这都没有关系，初学者只需要按照教程一步一步的去做，就一定会做到最后的结果。</p>
<p>达到结果后，再回过头去摸索教程中提到的所有概念。</p>
<p>下面罗列一些知识点，供你判定自己是否具有学习本课程的基础。</p>
<ol>
<li>正确理解JavaScript和Node的差异。</li>
<li>JavaScript编程基础 - 变量、数据格式、对象。</li>
<li>JavaScript异步函数。</li>
<li>JavaScript引用模块方式- require。</li>
<li>html + css使用基础。</li>
<li>运用vue的操作html。</li>
</ol>
<h1 id="准备"><a href="#准备" class="headerlink" title="准备"></a>准备</h1><p>本指导书将以Node为开发环境讲解如何开发WebAapp，在学习之前需要安装NVM和Node.js。</p>
<h2 id="1-安装NVM-详情"><a href="#1-安装NVM-详情" class="headerlink" title="1. 安装NVM(详情)"></a>1. 安装NVM(<a href="https://code.7xinsheng.com/post/59d3b2b9fbbefc4e650f4c14" target="_blank" rel="external">详情</a>)</h2><blockquote>
<p> nvm，即node version manager，node版本管理。可进行任意切换。</p>
</blockquote>
<p>安装nvm后，在终端执行下面命令查看nvm的版本，以判断是否安装成功。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">$ nvm --version      <span class="comment"># 查看是否安装</span></div><div class="line">$ curl -o- https://raw.githubusercontent.com/creationix/nvm/v0.33.2/install.sh | bash</div></pre></td></tr></table></figure>
<p><strong>为什么要用 nvm？</strong></p>
<p>开发经验：看任何一个 Node.js 项目，首先要读这个项目的 <a href="http://readme.md/" target="_blank" rel="external">README.md</a>。其次，要掌握项目的核心，就要看 <code>package.json</code> 这个文件，关键的是要看 Node.js 的版本。不同项目用的 Node.js 的版本是不一样的。而 nvm 就可以很方便地安装/切换多个版本的 Node.js。</p>
<p>部分同学电脑环境的原因，会无法安装 nvm。这样的话，装一个比较新版的 Node.js 就行，比如 8.0.0（或者最新版）。</p>
<h2 id="2-安装Node-js"><a href="#2-安装Node-js" class="headerlink" title="2. 安装Node.js"></a>2. 安装Node.js</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">$ nvm install 8.1.1</div><div class="line">$ node --version       <span class="comment"># 判断是否安装成功</span></div><div class="line">$ node 				   <span class="comment"># 执行测试</span></div><div class="line">$ console.log(<span class="string">'hello, js'</span>)</div></pre></td></tr></table></figure>
<p>退出node编辑模式： cmd + c 两次</p>
<hr>
<h1 id="基于Express创建WebAPP"><a href="#基于Express创建WebAPP" class="headerlink" title="基于Express创建WebAPP"></a>基于<a href="http://www.expressjs.com.cn/" target="_blank" rel="external">Express</a>创建WebAPP</h1><blockquote>
<p> Express是基于 <a href="http://nodejs.org/" target="_blank" rel="external">Node.js</a> 平台，快速、开放、极简的 web 开发框架。<a href="http://code.7xinsheng.com/post/59d3af6bfbbefc4e650f4c07" target="_blank" rel="external">more</a></p>
</blockquote>
<p>一个好的架构能给我们带来什么？更方便的处理视图(HTML)，更方便的处理路由（/page1，/page2）。</p>
<p>express提供了一个终端的指令集，可以在终端一键初始化一个项目结构，并立马执行就能启动一个webapp。剩下的你只需要填鸭子一样填入自己的文件和代码。</p>
<p>以下是在本机终端快速生成一个webapp项目：</p>
<h2 id="安装express"><a href="#安装express" class="headerlink" title="安装express"></a>安装express</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ npm install -g express-generator@4  <span class="comment">#global全局安装，版本4</span></div></pre></td></tr></table></figure>
<p><strong>教程中为什么要全局安装？</strong></p>
<p>框架性的项目，要看框架解决的是什么东西，如果是基于某种语言、某种环境，快速方便的基于它来开发做项目。一般会提供一组终端的操作命令，让我们快速的基于它来做一个项目。所有的框架性的项目，都可以实现这样的需求，所以教程中让我们全局安装。</p>
<p>安装方式：</p>
<ol>
<li>全局安装（默认帮我们建立一个工程，为开发者搭建好了基础的脚手架，这样就不用从零开始了）</li>
<li>当做第三方库来使用。（在page.json 里面引用）</li>
</ol>
<h2 id="创建一个新的WebApp"><a href="#创建一个新的WebApp" class="headerlink" title="创建一个新的WebApp"></a>创建一个新的WebApp</h2><ul>
<li>创建并进入first-app文件夹</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">$ mkdir first-app          <span class="comment"># 目录first-app就是你的工程文件夹</span></div><div class="line">$ <span class="built_in">cd</span> first-app</div></pre></td></tr></table></figure>
<ul>
<li>在当前目录执行express来创建一个<strong>基于Express的WebApp</strong></li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ express --view=ejs       <span class="comment"># 使用ejs的视图引擎</span></div></pre></td></tr></table></figure>
<p>执行express后，要注意观察输出的信息：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">...</div><div class="line"></div><div class="line">   install dependencies:</div><div class="line">     $ <span class="built_in">cd</span> . &amp;&amp; npm install</div><div class="line"></div><div class="line">   run the app:</div><div class="line">     $ DEBUG=first-app:* npm start</div></pre></td></tr></table></figure>
<h2 id="安装first-app的依赖包"><a href="#安装first-app的依赖包" class="headerlink" title="安装first-app的依赖包"></a>安装first-app的依赖包</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ npm install</div></pre></td></tr></table></figure>
<h2 id="运行first-app"><a href="#运行first-app" class="headerlink" title="运行first-app"></a>运行first-app</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ DEBUG=first-app:* npm start       <span class="comment"># 或者npm start</span></div></pre></td></tr></table></figure>
<p>预览结果：浏览器打开 localhost:3000或127.0.0.1:3000</p>
<h2 id="补充知识"><a href="#补充知识" class="headerlink" title="补充知识"></a>补充知识</h2><ol>
<li>启动项目的时候，在 <code>npm start</code> 前面的命令，是为了在项目启动时，向 <code>process.env</code> 传递参数:</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ DEBUG=first-app:* PORT=3001 ABC=123 npm start</div></pre></td></tr></table></figure>
<p>预览结果：浏览器打开 localhost:3001</p>
<p>如参数<code>DEBUG=first-app:*</code>, <code>PORT=3001</code>,<code>ABC=123</code></p>
<p>如果在<code>app.js</code>里面添加<code>app.listen(4000)</code>，那么localhost:4000也可以同时浏览。</p>
<ol>
<li>在<code>./bin/www</code>输入以下内容：</li>
</ol>
<figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="built_in">console</span>.log(process.env);</div><div class="line"><span class="built_in">console</span>.log(process.env.ABC);</div><div class="line"><span class="built_in">console</span>.log(process.env.PORT);</div><div class="line"><span class="built_in">console</span>.log(process.env.DEBUG);</div></pre></td></tr></table></figure>
<p>运行以下代码：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ node ./bin/www</div></pre></td></tr></table></figure>
<p>可看到具体内容：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">&#123; npm_config_save_dev: <span class="string">''</span>,</div><div class="line">......&#125;</div><div class="line">123</div><div class="line">3001</div><div class="line">first-app:*</div></pre></td></tr></table></figure>
<h1 id="项目结构"><a href="#项目结构" class="headerlink" title="项目结构"></a>项目结构</h1><h2 id="总览"><a href="#总览" class="headerlink" title="总览"></a>总览</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line">- ../my_project/first-app/          # 工程目录</div><div class="line">    - bin/                          # 存放命令行相关代码</div><div class="line">        www                         # express的入口文件</div><div class="line">    - public/                       # 存放静态资源，前端执行的资源文件。</div><div class="line">        javascripts</div><div class="line">        images</div><div class="line">        + stylesheets</div><div class="line">    - routes/                       # 存放路由逻辑，相当于“动静脉”</div><div class="line">        index.js</div><div class="line">        users.js</div><div class="line">    - views/                        # 存放页面模板</div><div class="line">        index.ejs</div><div class="line">        layout.ejs</div><div class="line">        error.ejs</div><div class="line">    package.json                    # 配置文件</div><div class="line">    app.js                          # 主程序文件，相当于程序的大脑。</div></pre></td></tr></table></figure>
<h3 id="为什么默认有好几个文件夹？"><a href="#为什么默认有好几个文件夹？" class="headerlink" title="为什么默认有好几个文件夹？"></a>为什么默认有好几个文件夹？</h3><ul>
<li><p>一个 WebApp 的工程目录应该长什么样子？</p>
<p>好的项目，是根据丰富的经验来规定工程中的目录结构的。</p>
</li>
<li><p>一个工程最重要的是什么？</p>
<p>入口文件。比如买了一台电脑，最开始的时候，要先找到电脑开关。</p>
</li>
<li><p>对于 Node.js 项目来说，最重要的是什么？</p>
<p><code>package.json</code></p>
<p>这个文件中，<code>scripts</code> 字段里就会写项目从哪里开始运行。</p>
</li>
<li><p>依赖包（第三方库）又决定了什么？</p>
<p>决定了一个项目会有什么功能。</p>
</li>
</ul>
<p>这就是学习一个 Node.js 项目的高频小套路！</p>
<h2 id="bin"><a href="#bin" class="headerlink" title="/bin"></a>/bin</h2><figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">./bin</div><div class="line">./bin/www</div></pre></td></tr></table></figure>
<p>目录<code>./bin</code>下只有一个文件<code>www</code>,文件<code>www</code>是整个first-app的入口文件（也可称为first-app的启动文件），运行first-app时要指定运行该文件，然后由该文件的内部代码去调用./app.js。</p>
<p>注：<code>./bin/www</code>文件不是必须的。</p>
<h2 id="public"><a href="#public" class="headerlink" title="/public"></a>/public</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">./public</div><div class="line">./public/javascripts</div><div class="line">./public/images</div><div class="line">./public/stylesheets</div><div class="line">./public/stylesheets/style.css</div></pre></td></tr></table></figure>
<p>目录/public是WebAPP存放静态资源的地方。这些静态资源包含css文件、浏览器运行的js文件、图片文件等。静态资源不需要设置任何路由就能直接通过链接访问。<u>（前端执行的资源文件）</u></p>
<p>比如通过<a href="http://localhost:3000/stylesheets/style.css" target="_blank" rel="external">http://localhost:3000/stylesheets/style.css</a> 可以在浏览器直接读取style.css，这样做的目的是方便浏览器再解析html页面时更方便得获得静态资源。</p>
<h2 id="routes"><a href="#routes" class="headerlink" title="/routes"></a>/routes</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">./routes</div><div class="line">./routes/index.js</div><div class="line">./routes/users.js</div></pre></td></tr></table></figure>
<p>目录<code>./routes</code>是处理所有路由逻辑的地方。<u>express动静脉</u></p>
<h2 id="views"><a href="#views" class="headerlink" title="/views"></a>/views</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">./views</div><div class="line">./views/index.ejs</div><div class="line">./views/layout.ejs</div><div class="line">./views/error.ejs</div></pre></td></tr></table></figure>
<p>目录<code>./views</code>是放置页面模板的地方。WebAPP要给用户返回html页面时，都是用<code>./views</code>中页面模板来生成html文件。不是必需的，若开发的 WebApp 有前端页面的话，自然也是不可少的；若只有数据则不需要。</p>
<h2 id="配置文件"><a href="#配置文件" class="headerlink" title="配置文件"></a>配置文件</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">./package.json</div></pre></td></tr></table></figure>
<p>文件<code>./package.json</code>是整个WebApp的管理依赖包的地方。</p>
<blockquote>
<p> 依赖包：当WebApp需要调用别人已经开发好的模块时，就需要将模块名和版本号写到到package.json里。这个模块就是WebAapp的依赖包，或称为依赖模块。</p>
</blockquote>
<p>除了管理依赖包，package.json还有WebAapp的名字和版本号信息。</p>
<p>脚本信息：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">DEBUG=first-app:* npm start</div></pre></td></tr></table></figure>
<p>npm start中的<code>start</code>就是在package.json中定义的一个脚本。</p>
<p>执行<code>npm start</code>，事实上是在执行<code>node ./bin/www</code>。</p>
<p>每一个项目都是不同开发同学开发的，项目的入口文件可能都不同，如果大家都遵循一种原则，在package.json中配置好start的执行脚本，那么别人就知道直接执行npm start就可以运行项目了。</p>
<p>如果有必要，还可以在”script”结构里扩展更多的脚本。</p>
<h2 id="主程序文件"><a href="#主程序文件" class="headerlink" title="主程序文件"></a>主程序文件</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">./app.js</div></pre></td></tr></table></figure>
<p>前面提过<code>/bin/www</code>文件是整个WebApp的启动文件，在<code>/bin/www</code>文件中最核心的代码是调用<code>./app.js</code>，而整个WebApp最核心的代码就是<code>./app.js</code>。</p>
<h3 id="额外知识"><a href="#额外知识" class="headerlink" title="额外知识"></a>额外知识</h3><h4 id="bin-www文件不是必须的"><a href="#bin-www文件不是必须的" class="headerlink" title="./bin/www文件不是必须的"></a><code>./bin/www</code>文件不是必须的</h4><p>可直接删除<code>./bin/www</code>，并在<code>app.js</code>里面添加以下内容：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">app.listen(<span class="number">4000</span>)</div></pre></td></tr></table></figure>
<p>输入以下代码执行程序，打开<code>localhost:4000</code>查看：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ node app.js</div></pre></td></tr></table></figure>
<h4 id="为什么官网的示例和项目中的关键代码不一样？"><a href="#为什么官网的示例和项目中的关键代码不一样？" class="headerlink" title="为什么官网的示例和项目中的关键代码不一样？"></a>为什么官网的示例和项目中的关键代码不一样？</h4><h5 id="express官网的最小可行性代码"><a href="#express官网的最小可行性代码" class="headerlink" title="express官网的最小可行性代码"></a><strong>express官网的最小可行性代码</strong></h5><figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> express = <span class="built_in">require</span>(<span class="string">'express'</span>)</div><div class="line"><span class="keyword">var</span> app = express()</div><div class="line"></div><div class="line">app.get(<span class="string">'/'</span>,<span class="function"><span class="keyword">function</span> (<span class="params">req, res</span>)</span>&#123;</div><div class="line">  res.send(<span class="string">'Hello World'</span>)</div><div class="line">&#125;)</div><div class="line"></div><div class="line">app.listen(<span class="number">3000</span>)</div></pre></td></tr></table></figure>
<h5 id="app-js最小可行性代码"><a href="#app-js最小可行性代码" class="headerlink" title="app.js最小可行性代码"></a><strong><code>app.js</code>最小可行性代码</strong></h5><figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> app = <span class="built_in">require</span>(<span class="string">'../app'</span>);  </div><div class="line">var http = require('http');            # 或 var path = require('path');</div><div class="line">var server = http.createServer(app);   # 调app的库</div><div class="line">server.listen(3000);				   # 监听3000窗口</div><div class="line"><span class="built_in">module</span>.exports = app;</div></pre></td></tr></table></figure>
<p>页面显示”Cannot GET”，是express自己给的。</p>
<p>“废代码”的功能，是为了实现健壮性。代码也需要处理各种各样的事情，不可能只去做最核心的功能。所以为了实现健壮性，必须要有冗余。</p>
<h5 id="app-js能直接重命名"><a href="#app-js能直接重命名" class="headerlink" title="app.js能直接重命名"></a><code>app.js</code>能直接重命名</h5><p>直接从 <code>app.js</code>（或者重命名为 <code>server.js</code>、<code>index.js</code>），这样更形象，也更直接。将<code>package.json</code>里面的代码相应改为：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">// 把原本的app.js改为server.js</div><div class="line">&#123;</div><div class="line">  ...</div><div class="line">  "scripts": &#123;</div><div class="line">    "start": "node ./server.js",</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>并在终端里执行<code>node server.js</code></p>
<h1 id="认识路由"><a href="#认识路由" class="headerlink" title="认识路由"></a>认识路由</h1><p>在浏览器中输入<code>localhost:3000/</code>和<code>localhost:3000/users</code>，分别会看到不同的页面。</p>
<p>first-app对两个不同的地址请求做出了不同的反应。</p>
<p>当first-app收到浏览器的请求后，会对<code>/</code>和<code>/users</code>做出不同的反应，换句话说是会针对不同的路由执行不同的代码。判断是<code>/</code>后就执行routes/index.js，判断是<code>/users</code>后就执行routes/users.js。</p>
<p>假如输入localhost:3000/posts，first-app并没有处理<code>/posts</code>，会返回错误页面的处理。</p>
<p><img src="https://ws2.sinaimg.cn/large/006tKfTcgy1flcwz9kmekj31fw1f0ai7.jpg" alt=""></p>
<h2 id="加载路由的逻辑处理模块"><a href="#加载路由的逻辑处理模块" class="headerlink" title="加载路由的逻辑处理模块"></a>加载路由的逻辑处理模块</h2><p>在first-app/app.js文件中有如下代码。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">var index = require(&apos;./routes/index&apos;);</div><div class="line">var users = require(&apos;./routes/users&apos;);</div></pre></td></tr></table></figure>
<p>通过require()分别加载了./routes/index和./routes/users两个文件模块。这两个文件模块是处理路由的逻辑文件。</p>
<h2 id="设置路由和逻辑处理模块"><a href="#设置路由和逻辑处理模块" class="headerlink" title="设置路由和逻辑处理模块"></a>设置路由和逻辑处理模块</h2><p>在first-app/app.js文件中设置了路由和逻辑处理模块的关系。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> index = <span class="built_in">require</span>(<span class="string">'./routes/index'</span>);</div><div class="line"><span class="keyword">var</span> users = <span class="built_in">require</span>(<span class="string">'./routes/users'</span>);</div><div class="line"></div><div class="line">...</div><div class="line"></div><div class="line">app.use(<span class="string">'/'</span>, index);</div><div class="line">app.use(<span class="string">'/users'</span>, users);</div><div class="line"></div><div class="line">...</div></pre></td></tr></table></figure>
<ul>
<li>输入地址localhost:3000/（路由为/） 就执行 index模块</li>
<li>输入地址 localhost:3000/users （路由为/users）就执行 users模块。</li>
<li>除了<code>/</code>和<code>/users</code>之外就没有处理其他路由的模块<ul>
<li>输入 localhost:3000/posts，因为<code>/posts</code>并没有被处理，所以返回错误页面。如下：</li>
</ul>
</li>
</ul>
<p>在first-app/app.js中针对其他路由都会执行统一的代码并返回一个错误页面。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// catch 404 and forward to error handler</span></div><div class="line"></div><div class="line">app.use(<span class="function"><span class="keyword">function</span>(<span class="params">req, res, next</span>) </span>&#123;</div><div class="line">  <span class="keyword">var</span> err = <span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">'Not Found'</span>);</div><div class="line">  err.status = <span class="number">404</span>;</div><div class="line">  next(err);</div><div class="line">&#125;);</div></pre></td></tr></table></figure>
<h3 id="额外知识-1"><a href="#额外知识-1" class="headerlink" title="额外知识"></a>额外知识</h3><ol>
<li>第一二行是怎么进入到下面的函数的？</li>
</ol>
<figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">app.use(<span class="string">'/'</span>, index);</div><div class="line">app.use(<span class="string">'/users'</span>, users);</div><div class="line"></div><div class="line"><span class="comment">// catch 404 and forward to error handler</span></div><div class="line">app.use(<span class="function"><span class="keyword">function</span>(<span class="params">req, res, next</span>) </span>&#123;</div><div class="line">  <span class="keyword">var</span> err = <span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">'Not Found'</span>);</div><div class="line">  err.status = <span class="number">404</span>;</div><div class="line">  next(err);</div><div class="line">&#125;);</div></pre></td></tr></table></figure>
<ul>
<li>所有路由会先根据URL/后面的内容开始与<code>&#39;/&#39;</code> ,<code>/users</code>进行匹配，然后按顺序下去。</li>
<li><code>next</code>机制，省去很多麻烦。表示下一个的意思。工作机制以后讲。</li>
</ul>
<ol>
<li>可添加其他页面截流：</li>
</ol>
<figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// catch 500 and forward to error handler</span></div><div class="line">app.use(<span class="string">'/posts'</span>,<span class="function"><span class="keyword">function</span>(<span class="params">req, res, next</span>) </span>&#123;</div><div class="line">  <span class="keyword">var</span> err = <span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">'Not Found Posts'</span>);</div><div class="line">  err.status = <span class="number">500</span>;</div><div class="line">  next(err);</div><div class="line">&#125;);</div><div class="line"></div><div class="line"><span class="comment">// 如果没有被截流，最后都会执行的代码。像try&#123;...&#125;catch()；</span></div><div class="line">app.use(<span class="function"><span class="keyword">function</span>(<span class="params">req, res, next</span>) </span>&#123;</div><div class="line">  <span class="keyword">var</span> err = <span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">'Not Found'</span>);</div><div class="line">  err.status = <span class="number">404</span>;</div><div class="line">  next(err);</div><div class="line">&#125;);</div><div class="line"><span class="comment">// 这是一个设计方法学，express最简单的截流方式，像ifelse</span></div><div class="line">app.use(<span class="function"><span class="keyword">function</span>(<span class="params">err, req, res, next</span>) </span>&#123;</div><div class="line">  <span class="comment">// set locals, only providing error in development</span></div><div class="line">  res.locals.message = err.message;</div><div class="line">  res.locals.error = req.app.get(<span class="string">'env'</span>) === <span class="string">'development'</span> ? err : &#123;&#125;;</div><div class="line"></div><div class="line">  <span class="comment">// render the error page</span></div><div class="line">  res.status(err.status || <span class="number">500</span>);</div><div class="line">  res.render(<span class="string">'error'</span>);</div><div class="line">&#125;);</div></pre></td></tr></table></figure>
<h2 id="路由和逻辑处理"><a href="#路由和逻辑处理" class="headerlink" title="路由和逻辑处理"></a>路由和逻辑处理</h2><p>路由<code>/</code>对应的逻辑模块是routes/index.js。一般情况下<code>/</code>路由对应的页面成为首页（或主页）。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/* GET home page. */</span></div><div class="line">router.get(<span class="string">'/'</span>, <span class="function"><span class="keyword">function</span>(<span class="params">req, res, next</span>) </span>&#123;</div><div class="line">  res.render(<span class="string">'index'</span>, &#123; <span class="attr">title</span>: <span class="string">'Express'</span> &#125;);  <span class="comment">// 把"Express"修改为"my first WebApp"</span></div><div class="line">&#125;);</div></pre></td></tr></table></figure>
<p>路由<code>/users</code>对应的逻辑模块是<code>/routes/users.js</code>。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/* GET users listing. */</span></div><div class="line"></div><div class="line">router.get(<span class="string">'/'</span>, <span class="function"><span class="keyword">function</span>(<span class="params">req, res, next</span>) </span>&#123;</div><div class="line">  res.send(<span class="string">'respond with a resource'</span>);   <span class="comment">// 修改为“zhangsan, lisi, wangermazi”</span></div><div class="line">&#125;);</div></pre></td></tr></table></figure>
<p>重新运行first-app再刷新页面看结果。</p>
<h3 id="额外知识-2"><a href="#额外知识-2" class="headerlink" title="额外知识"></a>额外知识</h3><p>为什么<code>./routes/users.js</code>里面只需要写<code>&#39;/&#39;</code>，路由就能够直接引导到<code>/users</code></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/* GET users listing. */</span></div><div class="line">router.get(<span class="string">'/'</span>, <span class="function"><span class="keyword">function</span>(<span class="params">req, res, next</span>) </span>&#123;</div><div class="line">  res.send(<span class="string">'zhangsan, lisi, wangermazi'</span>);</div><div class="line">&#125;);</div><div class="line"></div><div class="line"><span class="comment">/* GET users/abc listing. */</span></div><div class="line">router.get(<span class="string">'/abc'</span>, <span class="function"><span class="keyword">function</span>(<span class="params">req, res, next</span>) </span>&#123;</div><div class="line">  res.send(<span class="string">'zhangsan, lisi, wangermazi'</span>);</div><div class="line">&#125;);</div></pre></td></tr></table></figure>
<p>因为<code>app.js</code>里面已经指定了在<code>./routes/users.js</code>，所以可以直接忽略。像分发快递一样。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">app.use(<span class="string">'/users'</span>, users);</div></pre></td></tr></table></figure>
<p>参考事例 <a href="https://github.com/xugy0926/learn-webapp-sample/tree/master/first-app-sample-1" target="_blank" rel="external">first-app-sample-1</a></p>
<h1 id="配置执行项目的脚本"><a href="#配置执行项目的脚本" class="headerlink" title="配置执行项目的脚本"></a>配置执行项目的脚本</h1><p>当修改了first-app的代码后，总是要先停止项目然后再重新启动first-app。</p>
<p>在终端输入快捷组合键<code>ctrl + c</code>停止运行first-app服务，再执行运行指令运行服务。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ DEBUG=first-app:* npm start</div></pre></td></tr></table></figure>
<p>上面是正常的做法，但很麻烦。我们可以利用supervisor来监听文件被修改后自动重起项目。</p>
<h2 id="全局配置supervisor"><a href="#全局配置supervisor" class="headerlink" title="全局配置supervisor"></a>全局配置supervisor</h2><p>安装supervisor模块，一般采用全局安装，这样可以保证在终端的任何地方都可以直接使用supervisor。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ npm isntall -g supervisor</div></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">$ <span class="built_in">cd</span> first-app</div><div class="line">$ supervisor DEBUG=first-app:* node ./bin/www</div></pre></td></tr></table></figure>
<p>相比与全局安装，我更建议你在项目中安装supervisor，两个原因。</p>
<ol>
<li>不同的项目可以有不同版本的supervisor。当你下载了一个很老的项目，可能它依赖更早的superviaor版本，如果此时用了全局安装的supervisor会有问题。</li>
<li>每个项目的依赖环境越独立，这个项目就更安全、执行更方便。</li>
</ol>
<p>如果你全局安装了supervisor可以卸载</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ npm uninstall --global supervisor</div></pre></td></tr></table></figure>
<h2 id="在项目中配置supervisor脚本"><a href="#在项目中配置supervisor脚本" class="headerlink" title="在项目中配置supervisor脚本"></a>在项目中配置supervisor脚本</h2><p>在first-app项目中安装supervisor.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">$ <span class="built_in">cd</span> first-app</div><div class="line">$ npm install --save supervisor</div></pre></td></tr></table></figure>
<p>通过npm install安装supervisor时带上–save参数，会把supervisor配置到package.json中:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="string">"supervisor"</span>: <span class="string">"^0.12.0"</span></div></pre></td></tr></table></figure>
<p>然后在package.json的script字段中添加一个auto-start脚本</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="string">"scripts"</span>: &#123;</div><div class="line">  <span class="string">"start"</span>: <span class="string">"node ./bin/www"</span>,</div><div class="line">  <span class="string">"auto-start"</span>: <span class="string">"./node_modules/.bin/node-supervisor node ./bin/www"</span></div><div class="line">&#125;,</div></pre></td></tr></table></figure>
<p>以上执行成功后，往后只要执行下面指令就可以自动重启项目了</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ npm run auto-start</div></pre></td></tr></table></figure>
<p>参考事例 <a href="https://github.com/xugy0926/learn-webapp-sample/tree/master/first-app-sample-2" target="_blank" rel="external">first-app-sample-2</a></p>
<h1 id="添加新的路由和页面"><a href="#添加新的路由和页面" class="headerlink" title="添加新的路由和页面"></a>添加新的路由和页面</h1><p>一个路由对应一个页面或一个操作，学习如何添加路由和页面是开发WebApp的最基本的能力。</p>
<p>假如想让localhost:3000/posts这个地址打开一个对应的页面。一般都按照以下顺序来操作。</p>
<ol>
<li>添加一个文件，用来处理/<code>posts</code>路由。如：./routes/posts.js。</li>
<li>添加一个页面文件，与<code>/posts</code>路由对应的。如：./views/posts.ejs。</li>
<li>在<code>app.js</code>中，将<code>/posts</code>和<code>./routes/posts.js</code>进行关联。</li>
<li><code>在./routes/posts.js</code>中，把<code>./views/posts.ejs</code>页面返回给用户。</li>
</ol>
<h2 id="新建并编写-routes-posts-js"><a href="#新建并编写-routes-posts-js" class="headerlink" title="新建并编写./routes/posts.js"></a>新建并编写./routes/posts.js</h2><blockquote>
<p> <code>./routes/posts.js</code>用来处理路由<code>/posts</code>的逻辑，在这里你可以决定路由<code>/posts</code>是返回数据还是页面。</p>
</blockquote>
<ol>
<li><h3 id="复制代码"><a href="#复制代码" class="headerlink" title="复制代码"></a>复制代码</h3><p>只需要把<code>./routes/index.js</code>中的代码copy到<code>./routes/posts.js</code>即可。</p>
</li>
<li><h3 id="修改注释"><a href="#修改注释" class="headerlink" title="修改注释"></a>修改注释</h3><p>注释中的<code>Get Home page</code>要修改为<code>Get posts page</code>。这样就保证注释的正确性。</p>
</li>
<li><h3 id="修改返回的页面"><a href="#修改返回的页面" class="headerlink" title="修改返回的页面"></a>修改返回的页面</h3><p>将<code>res.render()</code>函数的第一个参数<code>&#39;index&#39;</code>修改为<code>&#39;posts&#39;</code>，对应着<code>/views/posts.ejs</code>文件。</p>
</li>
</ol>
<p>代码如下：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> express = <span class="built_in">require</span>(<span class="string">'express'</span>);</div><div class="line"><span class="keyword">var</span> router = express.Router();</div><div class="line"></div><div class="line"><span class="comment">/* GET posts page. */</span></div><div class="line">router.get(<span class="string">'/'</span>, <span class="function"><span class="keyword">function</span>(<span class="params">req, res, next</span>) </span>&#123;</div><div class="line">  res.render(<span class="string">'posts'</span>, &#123; <span class="attr">title</span>: <span class="string">'posts page.'</span> &#125;);</div><div class="line">&#125;);</div><div class="line"><span class="built_in">module</span>.exports = router;</div></pre></td></tr></table></figure>
<h2 id="新建并编写-views-posts-ejs的页面代码"><a href="#新建并编写-views-posts-ejs的页面代码" class="headerlink" title="新建并编写./views/posts.ejs的页面代码"></a>新建并编写./views/posts.ejs的页面代码</h2><blockquote>
<p> <code>./views/posts.ejs</code>是用来构建用户看到的html页面。</p>
</blockquote>
<ol>
<li>把/views/index.ejs的代码copy到/views/posts.ejs文件。</li>
<li>这样重新运行项目，在浏览器输入localhost:3000/posts</li>
</ol>
<h2 id="关联路由’-posts’和’-routes-posts-js’"><a href="#关联路由’-posts’和’-routes-posts-js’" class="headerlink" title="关联路由’/posts’和’/routes/posts.js’"></a>关联路由’/posts’和’/routes/posts.js’</h2><h3 id="思路"><a href="#思路" class="headerlink" title="思路"></a>思路</h3><p>我们可以顺一下处理逻辑。</p>
<ul>
<li>当浏览器输入地址<code>localhost:3000/</code>，最终代码会执行到<code>routes/index.js</code>中。</li>
<li>在<code>routes/index.js</code>中，会把<code>views/index.ejs</code>生产的html页面返回给用户。</li>
</ul>
<p>以上操作会产生两个疑惑。</p>
<ol>
<li>程序处理’/‘时，是怎么找到<code>./routes/index.js</code>的？这两者的关联性在哪里？如果知道关联性就能知道如何关联<code>&#39;/posts&#39;</code></li>
<li><code>routes/index.js</code>中的<code>res.render()</code>函数，为什么会把第一个参数<code>index</code>认为是<code>views/index.ejs</code>？关联性在哪里？</li>
</ol>
<h3 id="操作"><a href="#操作" class="headerlink" title="操作"></a>操作</h3><p>在<code>app.js</code>中，引入<code>./routes/posts.js</code>文件，并赋值给变量posts。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">var posts = require(&apos;./routes/posts&apos;);</div></pre></td></tr></table></figure>
<p>然后，将变量posts和路由’/posts’关联起来。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">app.use(&apos;/posts&apos;, posts);</div></pre></td></tr></table></figure>
<p><code>require()</code>是nodejs的一个全局函数，专门用于引用内部文件（模块）。</p>
<p>一个项目为了保证功能模块更清晰，会将不同的功能写在不同的文件里。</p>
<p>比如，./app.js控制路由，./routes/index.js处理某个路由逻辑，当./app.js要调用./routes/index.js时，就必须先将./routes/index.js引入进来。并用赋值给变量index。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> index = <span class="built_in">require</span>(<span class="string">'./routes/index'</span>);</div></pre></td></tr></table></figure>
<ul>
<li><code>require(&#39;./routes/posts.js&#39;)</code>和<code>require(&#39;./routes/posts&#39;)</code>是等价的。文件的后缀<code>.js</code>是可以不写的，写了也不会错。</li>
<li>将一个文件（模块）引入进来后就得使用，否则，引入一个文件（模块）就显得无意义。</li>
<li><code>app.use()</code>函数可以接受两个参数，第一个参数表示路由，第二个参数表示该路由对应的处理模块。</li>
</ul>
<p>通过app.use函数把路由/posts和逻辑处理./routes/posts.js文件关联起来了，整个代码就能走得通。</p>
<h2 id="如何让-routes-posts-js返回-views-posts-ejs这个页面"><a href="#如何让-routes-posts-js返回-views-posts-ejs这个页面" class="headerlink" title="如何让./routes/posts.js返回./views/posts.ejs这个页面"></a>如何让<code>./routes/posts.js</code>返回<code>./views/posts.ejs</code>这个页面</h2><p>在<code>./routes/posts.js</code>中，<code>res.render()</code>的第一个参数是<code>&#39;index&#39;</code>，如果把<code>&#39;index&#39;</code>直接改成<code>&#39;posts&#39;</code>是不是就可以了？答案是可以的。那为什么我输入<code>&#39;posts&#39;</code>就能关联到<code>&#39;./views/posts.ejs&#39;</code>这个文件呢？</p>
<p>奥秘是在于在./app.js里，项目已经实现把./views这个路径告诉了app。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">app.set(&apos;views&apos;, path.join(__dirname, &apos;views&apos;));</div></pre></td></tr></table></figure>
<p><code>app.set()</code>函数可以把一个值设置给app，这行代码的意思就是把./views这个路径设置给’views’这个字符串对应的值。那么，在代码执行时，app只要取出字符串’views’对应的路径即可。</p>
<p>所以，app是预先就知道了如果要找view相关的文件，就去./views的路径下找即可。现在，只需要把./routes/posts.js中的res.render()函数的第一个参数’index’改成’posts’即可。</p>
<h2 id="预览结果"><a href="#预览结果" class="headerlink" title="预览结果"></a>预览结果</h2><p>重新运行first-app，输入localhost:3000/posts，页面和localhost:3000/一样了就说明成功为first-app添加了一个新的访问路由/posts。</p>
<p>参考事例 <a href="https://github.com/xugy0926/learn-webapp-sample/tree/master/first-app-sample-3" target="_blank" rel="external">first-app-sample-3</a></p>
<h1 id="模板引擎"><a href="#模板引擎" class="headerlink" title="模板引擎"></a>模板引擎</h1><p>在express中，模板引擎也可以称为视图引擎。express引入模板引擎的目的是为了更好地构建html页面。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ express --view=ejs</div></pre></td></tr></table></figure>
<p>用express创建项目是，后面跟了一个–view参数，它的值是ejs。这个意图很明确：在创建express项目时使用ejs作为模板引擎。</p>
<p>项目创建成功后，在.app.js中可以看到以下代码。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// view engine setup</span></div><div class="line">app.set(<span class="string">'views'</span>, path.join(__dirname, <span class="string">'views'</span>));</div><div class="line">app.set(<span class="string">'view engine'</span>, <span class="string">'ejs'</span>);</div></pre></td></tr></table></figure>
<p>express已经帮我们构建好了查找view的位置和解析view的引擎。当我们要返回页面时，只要告诉res.render函数返回的页面的名字即可。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">res.render(<span class="string">'index'</span>, &#123; <span class="attr">title</span>: <span class="string">'Express'</span> &#125;);</div></pre></td></tr></table></figure>
<p>事实上，express只是应我们的要求，集成了ejs模块并封装了对ejs的处理。</p>
<p>ejs本身是一个express之外的第三方库，ejs的目的就是利用ejs模板文件和数据来构建html文件。比如上面的res.render函数其实是调用了ejs引擎，利用index.ejs模板文件和{ title: ‘Express’}数据构建html文件，并返回给用户。</p>
<p>在使用模板引擎时，express封装了对ejs引擎的调用，在调用res.render函数返回页面是我们只关注两件事情。</p>
<ol>
<li>用哪个模板？</li>
<li>给什么数据？</li>
</ol>
<p>但，除了以上两件事情之外，在开发期间，我们还要来定制ejs模板。</p>
<h1 id="定制ejs模板"><a href="#定制ejs模板" class="headerlink" title="定制ejs模板"></a>定制ejs模板</h1><p>我们拿posts.ejs为例，如何在posts.ejs中构建一个列表结构的html呢？</p>
<p>比如，在<code>posts.js</code>中我们给定一个列表postsList</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">router.get(<span class="string">'/'</span>, <span class="function"><span class="keyword">function</span>(<span class="params">req, res, next</span>) </span>&#123;</div><div class="line">  res.render(<span class="string">'posts'</span>, &#123; <span class="attr">title</span>: <span class="string">'posts'</span>, <span class="attr">postsList</span>: [<span class="string">'文章1'</span>, <span class="string">'文章2'</span>, <span class="string">'文章3'</span>] &#125;);</div><div class="line">&#125;);</div></pre></td></tr></table></figure>
<p>在<code>posts.ejs</code>中，应该利用数据postsList来构建列表模板。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line">&lt;!DOCTYPE html&gt;</div><div class="line">&lt;html&gt;</div><div class="line">  &lt;head&gt;</div><div class="line">    &lt;title&gt;&lt;%= title %&gt;&lt;/title&gt;</div><div class="line">    &lt;link rel=<span class="string">'stylesheet'</span> href=<span class="string">'/stylesheets/style.css'</span> /&gt;</div><div class="line">  &lt;<span class="regexp">/head&gt;</span></div><div class="line"><span class="regexp">  &lt;body&gt;</span></div><div class="line"><span class="regexp">    &lt;h1&gt;&lt;%= title %&gt;&lt;/</span>h1&gt;</div><div class="line">    &lt;p&gt;Welcome to &lt;%= title %&gt;&lt;/p&gt;</div><div class="line"></div><div class="line">    &lt;% <span class="keyword">for</span>(<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; postsList.length; i++) &#123; %&gt;</div><div class="line">    &lt;p&gt;&lt;%= postsList[i] %&gt;&lt;/p&gt;</div><div class="line">    &lt;% &#125; %&gt;</div><div class="line">  &lt;<span class="regexp">/body&gt;</span></div><div class="line"><span class="regexp">&lt;/</span>html&gt;</div></pre></td></tr></table></figure>
<p>ejs模板文件中可以嵌入代码，但代码一定是写在&lt;% %&gt;中：</p>
<ul>
<li>在正常的代码前后加上<code>&lt;% %&gt;</code>即可</li>
<li>使用某个变量的值要用<code>&lt;%= %&gt;</code></li>
<li>变量可以再计算<code>&lt;%= title + &#39; page&#39; %&gt;</code></li>
<li>执行某段代码用<code>&lt;% %&gt;</code></li>
</ul>
<p>参考事例 <a href="https://github.com/xugy0926/learn-webapp-sample/tree/master/first-app-sample-4" target="_blank" rel="external">first-app-sample-4</a></p>
<h1 id="延迟html渲染时机-客户端渲染数据"><a href="#延迟html渲染时机-客户端渲染数据" class="headerlink" title="延迟html渲染时机(客户端渲染数据)"></a>延迟html渲染时机(客户端渲染数据)</h1><h2 id="服务器构建技术"><a href="#服务器构建技术" class="headerlink" title="服务器构建技术"></a>服务器构建技术</h2><p><code>./routes/posts.js</code>里调用<code>res.render</code>函数处理用户的请求时，提供数据和ejs模板并最终交给了ejs引擎去构建html页面，然后再把页面返回给发出请求的用户。</p>
<p>这种在WebApp里依据数据构建好html的技术称为<strong>服务器构建技术</strong>，服务器会一起处理得妥妥的，浏览器获得html页面后只需要渲染html页面即可。</p>
<h2 id="客户端渲染数据"><a href="#客户端渲染数据" class="headerlink" title="客户端渲染数据"></a>客户端渲染数据</h2><p>除了服务器构建技术，还可以把依据数据构建html的过程延迟到浏览器去进行，大致处理步骤如下。</p>
<ol>
<li>通过/posts路由，获得对应的静态页面。</li>
<li>浏览器解析完页面后，通过axios向服务器发起http请求以获得文章数据。</li>
<li>拿到数据后通过vue来重新渲染页面。</li>
</ol>
<p>为了满足这个过程，必须创建一个获取文章列表的路由。</p>
<p>在<code>./routes/posts.js</code>中添加一个<code>/posts/list</code>的路由处理</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/* GET 获取postsList数据 */</span></div><div class="line">router.get(<span class="string">'/list'</span>, <span class="function"><span class="keyword">function</span>(<span class="params">req, res, next</span>) </span>&#123;</div><div class="line">  res.json(&#123;<span class="attr">postsList</span>: [<span class="string">'文章1'</span>, <span class="string">'文章2'</span>, <span class="string">'文章3'</span>] &#125;);</div><div class="line">&#125;);</div></pre></td></tr></table></figure>
<p>注意，这个路由通过<code>res.json()</code>函数返回一个对象数据。<code>res.json</code>可以将一个json对象返回给请求方。</p>
<p><code>./views/posts.ejs</code>引用vue和axios</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">&lt;head&gt;</div><div class="line">  &lt;title&gt;&lt;%= title %&gt;&lt;/title&gt;</div><div class="line">  &lt;link rel=<span class="string">'stylesheet'</span> href=<span class="string">'/stylesheets/style.css'</span> /&gt;</div><div class="line">  &lt;script src=<span class="string">"https://cdn.bootcss.com/vue/2.4.4/vue.min.js"</span>&gt;&lt;/script&gt;</div><div class="line">  &lt;script src=<span class="string">"https://cdn.bootcss.com/axios/0.16.2/axios.min.js"</span>&gt;&lt;/script&gt;</div><div class="line">&lt;<span class="regexp">/head&gt;</span></div></pre></td></tr></table></figure>
<p>在<code>./views/posts.ejs</code>中添加以下代码获得postsList并更新页面。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line">&lt;script&gt;</div><div class="line">  <span class="keyword">var</span> vm = <span class="keyword">new</span> Vue(&#123;</div><div class="line">    el: <span class="string">'#app'</span>,</div><div class="line">    data: &#123;</div><div class="line">      postsList: []</div><div class="line">    &#125;,</div><div class="line">    methods: &#123;</div><div class="line">      fetchData () &#123;</div><div class="line">        axios.get(<span class="string">'/posts/list'</span>)</div><div class="line">          .then(<span class="function"><span class="keyword">function</span>(<span class="params">response</span>) </span>&#123;</div><div class="line">            vm.postsList = response.data.postsList;</div><div class="line">          &#125;)</div><div class="line">      &#125;</div><div class="line">    &#125;</div><div class="line">  &#125;);</div><div class="line"></div><div class="line">  vm.fetchData();</div><div class="line">&lt;<span class="regexp">/script&gt;</span></div></pre></td></tr></table></figure>
<p>这块代码会在浏览器加载完html后才会执行，所以获取postsList被延迟到浏览器才执行，然后再利用vue更新html的机制来刷新页面。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">&lt;body&gt;</div><div class="line">  &lt;div id=<span class="string">"app"</span>&gt;</div><div class="line">    &lt;h1&gt;&lt;%= title %&gt;&lt;/h1&gt;</div><div class="line">    &lt;p&gt;Welcome to &lt;%= title %&gt;&lt;/p&gt;</div><div class="line"></div><div class="line">    &lt;p v-<span class="keyword">for</span>=<span class="string">"item in postsList"</span>&gt;&#123;&#123; item &#125;&#125;&lt;<span class="regexp">/p&gt;</span></div><div class="line"><span class="regexp">  &lt;/</span>div&gt;</div><div class="line">&lt;<span class="regexp">/body&gt;</span></div></pre></td></tr></table></figure>
<p>延迟html渲染时机这种技术称为客户端渲染。</p>
<p>参考 <a href="https://github.com/xugy0926/learn-webapp-sample/tree/master/first-app-sample-5" target="_blank" rel="external">first-app-sample-5</a></p>
<h1 id="渲染时机"><a href="#渲染时机" class="headerlink" title="渲染时机"></a>渲染时机</h1><p>什么是渲染？想要理解渲染就要理解整个从html生成到html显示的过程。早些时候，当用户通过浏览器访问网站时，Web服务器生成html页面并返回给浏览器，浏览器拿到html页面后，把html渲染成可视化的网页。从这个角度理解，渲染只是浏览器做的事情。</p>
<p>但是从今天的WebApp的发展来看，渲染主要指根据数据来构建html文件，而忽略掉浏览器将html渲染成可视化页面。这一点认知很重要。</p>
<p>在处理WebApp时，HTML页面的构成的时机主要有两种。</p>
<ol>
<li>【服务器渲染】在服务器端用数据构建好页面后，再给客户端。</li>
<li>【客户端渲染】服务器先给一个基本页面模板，然后由浏览器发起数据请求，再获得数据后在浏览器重新依据获得的数据再渲染页面。</li>
</ol>
<p>这两种渲染时机存在本质的区别。</p>
<h2 id="服务器渲染"><a href="#服务器渲染" class="headerlink" title="服务器渲染"></a>服务器渲染</h2><p>服务器渲染技术意味着整个页面的构建都是在服务端完成。</p>
<p>当用户通过浏览器发起一个打开网页的请求，WebApp收到请求后，会先去数据库抓取页面要显示的数据，然后根据数据来构建html，然后再返回给用户。</p>
<p><a href="https://github.com/xugy0926/learn-webapp-guideline/blob/master/assets/render-1.png" target="_blank" rel="external"><img src="https://github.com/xugy0926/learn-webapp-guideline/raw/master/assets/render-1.png" alt="img"></a></p>
<p>这种处理的特点是，构建整个页面的所有处理时间都在服务端。这个时间包括从数据库抓取数据和由数据构建html页面。</p>
<p>假如数据量大，或者构建页面的处理逻辑复杂，势必就导致一个请求在服务器的处理时间变长。</p>
<p>把并发请求由1个变成100000个，那么 WebApp 的处理能力就很有压力，会导致宕机。</p>
<h2 id="客户端渲染"><a href="#客户端渲染" class="headerlink" title="客户端渲染"></a>客户端渲染</h2><p>还是同样的案例，当用户通过浏览器发起一个打开网页的请求，WebApp收到请求后，立即给出页面模板，浏览器收到页面后，再去发起数据请求，浏览器页面获得数据后，在浏览器根据数据来渲染页面。</p>
<p><a href="https://github.com/xugy0926/learn-webapp-guideline/blob/master/assets/render-2.png" target="_blank" rel="external"><img src="https://github.com/xugy0926/learn-webapp-guideline/raw/master/assets/render-2.png" alt="img"></a></p>
<h2 id="如何选择用客户端渲染还是服务器渲染技术"><a href="#如何选择用客户端渲染还是服务器渲染技术" class="headerlink" title="如何选择用客户端渲染还是服务器渲染技术"></a>如何选择用客户端渲染还是服务器渲染技术</h2><p>这并没有一个特别的标准，主要还是看需求以及技术选型。</p>
<h3 id="选择服务器渲染"><a href="#选择服务器渲染" class="headerlink" title="选择服务器渲染"></a>选择服务器渲染</h3><ol>
<li>如果想开发一个blog或者论坛，服务器渲染技术够用了，blog和论坛都是一些相对静止的数据。</li>
<li>如果想开发一个公司的主站，就必须用服务器渲染</li>
</ol>
<h3 id="选择客户端渲染"><a href="#选择客户端渲染" class="headerlink" title="选择客户端渲染"></a>选择客户端渲染</h3><ol>
<li>如果想开发一个展示丰富化数据的页面，用客户端渲染，这样可以在客户端做出很多动态的交互。</li>
<li>如果开发一个页面有很多权限控制的内容，比如，聊天页面有群主，群成员等等，用客户端渲染比较好。</li>
</ol>
<h3 id="客户端渲染和服务器渲染混合着用"><a href="#客户端渲染和服务器渲染混合着用" class="headerlink" title="客户端渲染和服务器渲染混合着用"></a>客户端渲染和服务器渲染混合着用</h3><p>总之，选技术要看业务和产品经验。甚至你也可以把客户端渲染和服务器渲染混合着用（一个页面部分内容由服务端渲染产生，部分内容由客户端渲染产生）。</p>
<h2 id="有必要考虑SEO"><a href="#有必要考虑SEO" class="headerlink" title="有必要考虑SEO"></a>有必要考虑SEO</h2><blockquote>
<p> SEO的全称是 Search Engine Optimization（搜索引擎优化）。</p>
</blockquote>
<p>当你开发的一个页面希望被搜索引擎（baidu，google）收录，似乎只能考虑服务器渲染技术。搜索引擎的爬虫系统在互联网上爬取页面数据就是往每个服务发请求，如果你的页面渲染技术是客户端渲染的，搜索引擎没办法解释你的页面并动态判断是否还存在部分内容要进一步的去服务端抓取数据。这势必就导致你的页面内容没办法被收录。</p>
<p>但是我们又不能为了被搜索引擎收录而全部采用服务端渲染，怎么办？这要从业务角度来做一些切分。</p>
<p>给你一个非常直观有效判断依据：公司的主页请采用服务器渲染技术。其他的页面，看业务定。</p>
<h1 id="路由归类"><a href="#路由归类" class="headerlink" title="路由归类"></a>路由归类</h1><p>WebApp不仅可以提供页面能力，还能提供数据。</p>
<ul>
<li>访问<code>localhost:3000/posts</code>可以打开页面</li>
<li>访问<code>localhost:3000/posts/list</code>可以获取文章数据。</li>
</ul>
<p>当处理的路由很多的情况下，管理路由就会成为灾难。</p>
<p>想一下，如果不断增加first-app的页面，在.app.js文中下面的代码将会不断的膨胀。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">app.use(&apos;/&apos;, index);</div><div class="line">app.use(&apos;/users&apos;, users);</div><div class="line">app.use(&apos;/posts&apos;, posts);</div></pre></td></tr></table></figure>
<p>在路由控制上应该加以区分才能保证first-app的结构更清晰更易维护。</p>
<p>在设计WebApp时把提供数据的路由称为接口，一般都带有api。</p>
<h2 id="页面路由"><a href="#页面路由" class="headerlink" title="页面路由"></a>页面路由</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">localhost:3000/      // 获取主页</div><div class="line">localhost:3000/users // 获取users页面</div><div class="line">localhost:3000/posts // 获取posts页面</div></pre></td></tr></table></figure>
<h2 id="数据路由"><a href="#数据路由" class="headerlink" title="数据路由"></a>数据路由</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">localhost:3000/api/posts  // 获取posts列表</div></pre></td></tr></table></figure>
<p>以上的分类会帮助我们更好的维护对路由的处理，然后只需要两个路由处理文件即可。</p>
<ol>
<li>新建<code>route.page.js</code></li>
</ol>
<figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> express = <span class="built_in">require</span>(<span class="string">'express'</span>);</div><div class="line"><span class="keyword">var</span> router = express.Router();</div><div class="line"></div><div class="line"><span class="comment">/* GET home page. */</span></div><div class="line">router.get(<span class="string">'/'</span>, <span class="function"><span class="keyword">function</span>(<span class="params">req, res, next</span>) </span>&#123;</div><div class="line">  res.render(<span class="string">'index'</span>, &#123; <span class="attr">title</span>: <span class="string">'Express'</span> &#125;);</div><div class="line">&#125;);</div><div class="line"></div><div class="line"><span class="comment">/* GET posts page. */</span></div><div class="line">router.get(<span class="string">'/posts'</span>, <span class="function"><span class="keyword">function</span>(<span class="params">req, res, next</span>) </span>&#123;</div><div class="line">  res.render(<span class="string">'posts'</span>, &#123; <span class="attr">title</span>: <span class="string">'posts'</span>&#125; );</div><div class="line">&#125;);</div><div class="line"></div><div class="line"><span class="built_in">module</span>.exports = router;</div></pre></td></tr></table></figure>
<ol>
<li>新建<code>route.api.js</code></li>
</ol>
<figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> express = <span class="built_in">require</span>(<span class="string">'express'</span>);</div><div class="line"><span class="keyword">var</span> router = express.Router();</div><div class="line"></div><div class="line"><span class="comment">/* GET users lists. */</span></div><div class="line">router.get(<span class="string">'/users'</span>, <span class="function"><span class="keyword">function</span>(<span class="params">req, res, next</span>) </span>&#123;</div><div class="line">  res.send(<span class="string">'respond with a resource'</span>);</div><div class="line">&#125;);</div><div class="line"></div><div class="line"><span class="comment">/* GET posts lists */</span></div><div class="line">router.get(<span class="string">'/posts'</span>, <span class="function"><span class="keyword">function</span>(<span class="params">req, res, next</span>) </span>&#123;</div><div class="line">  res.json(&#123;<span class="attr">postsList</span>: [<span class="string">'文章1'</span>, <span class="string">'文章2'</span>, <span class="string">'文章3'</span>]&#125;);</div><div class="line">&#125;)</div><div class="line"></div><div class="line"><span class="built_in">module</span>.exports = router;</div></pre></td></tr></table></figure>
<ol>
<li>修改<code>app.js</code>的路由和处理文件的对应关系</li>
</ol>
<figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> page = <span class="built_in">require</span>(<span class="string">'./route.page'</span>);</div><div class="line"><span class="keyword">var</span> api = <span class="built_in">require</span>(<span class="string">'./route.api'</span>);</div><div class="line"></div><div class="line">...</div><div class="line"></div><div class="line">app.use(<span class="string">'/'</span>, page);</div><div class="line">app.use(<span class="string">'/api'</span>, api);</div></pre></td></tr></table></figure>
<ol>
<li>修改<code>./views/posts.ejs</code></li>
</ol>
<figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">fetchData () &#123;</div><div class="line">  axios.get(<span class="string">'/api/posts'</span>)</div><div class="line">    .then(<span class="function"><span class="keyword">function</span>(<span class="params">response</span>) </span>&#123;</div><div class="line">      vm.postsList = response.data.postsList;</div><div class="line">    &#125;)</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>通过以上的操作我们把路由重新归类整理了一番，以保证后续能更好的开发功能。</p>
<p>参考 <a href="https://github.com/xugy0926/learn-webapp-sample/tree/master/first-app-sample-6" target="_blank" rel="external">first-app-sample-6</a></p>
<h1 id="处理HTTP-POST请求"><a href="#处理HTTP-POST请求" class="headerlink" title="处理HTTP POST请求"></a>处理HTTP POST请求</h1><p>前面都是处理GET请求，通过GET请求获取页面和数据。处理POST请求也是WebApp的能力之一。通过页面输入数据并发送到WebApp的处理过程是怎么样的呢？大致过程分以下过程。</p>
<ol>
<li>设计一个路由对应一个编辑页面。</li>
<li>用户通过路由打开页面后，输入内容，并发送HTTP POST请求把数据给WebApp。</li>
<li>WebApp收到请求，依据路由分发到对应的处理模块。</li>
<li>处理模块获取用户的数据并进行相应处理。</li>
</ol>
<p>新建一个路由返回新建文章的页面</p>
<p>在<code>route.page.js</code>增加路由<code>&#39;/posts/create&#39;</code>的处理</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/* GET posts edit page. */</span></div><div class="line">router.get(<span class="string">'/posts/create'</span>, <span class="function"><span class="keyword">function</span>(<span class="params">req, res, next</span>) </span>&#123;</div><div class="line">  res.render(<span class="string">'create'</span>);</div><div class="line">&#125;);</div></pre></td></tr></table></figure>
<p>新建一个编辑页面create.ejs</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div></pre></td><td class="code"><pre><div class="line">&lt;!DOCTYPE html&gt;</div><div class="line">&lt;html&gt;</div><div class="line">  &lt;head&gt;</div><div class="line">    &lt;link rel=<span class="string">'stylesheet'</span> href=<span class="string">'/stylesheets/style.css'</span> /&gt;</div><div class="line">    &lt;link href=<span class="string">"https://cdn.bootcss.com/bootstrap/3.3.6/css/bootstrap.min.css"</span> rel=<span class="string">"stylesheet"</span>&gt;</div><div class="line">    &lt;script src=<span class="string">"https://cdn.bootcss.com/vue/2.4.4/vue.min.js"</span>&gt;&lt;/script&gt;</div><div class="line">    &lt;script src=<span class="string">"https://cdn.bootcss.com/axios/0.16.2/axios.min.js"</span>&gt;&lt;/script&gt;</div><div class="line">  &lt;<span class="regexp">/head&gt;</span></div><div class="line"><span class="regexp">  &lt;body&gt;</span></div><div class="line"><span class="regexp">    &lt;div id="app"&gt;</span></div><div class="line"><span class="regexp">      &lt;h1&gt;新建文章&lt;/</span>h1&gt;</div><div class="line">      &lt;div <span class="class"><span class="keyword">class</span></span>=<span class="string">"form-group"</span>&gt;</div><div class="line">        &lt;input type=<span class="string">"text"</span> <span class="class"><span class="keyword">class</span></span>=<span class="string">"form-control"</span> v-model=<span class="string">"title"</span> placeholder=<span class="string">"输入文字标题"</span>&gt;</div><div class="line">      &lt;<span class="regexp">/div&gt;</span></div><div class="line"><span class="regexp">      &lt;div class="form-group"&gt;</span></div><div class="line"><span class="regexp">        &lt;textarea class="form-control" rows="3" v-model="content" placeholder="输入文章内容"&gt;&lt;/</span>textarea&gt;</div><div class="line">      &lt;<span class="regexp">/div&gt;</span></div><div class="line"><span class="regexp">      &lt;div class="form-group"&gt;</span></div><div class="line"><span class="regexp">        &lt;button class="btn btn-default" v-on:click="submit"&gt;提交&lt;/</span>button&gt;</div><div class="line">      &lt;<span class="regexp">/div&gt;</span></div><div class="line"><span class="regexp">    &lt;/</span>div&gt;</div><div class="line">  &lt;<span class="regexp">/body&gt;</span></div><div class="line"><span class="regexp">&lt;/</span>html&gt;</div><div class="line">&lt;script&gt;</div><div class="line"><span class="keyword">var</span> vm = <span class="keyword">new</span> Vue(&#123;</div><div class="line">  el: <span class="string">'#app'</span>,</div><div class="line">  data: &#123;</div><div class="line">    title: <span class="string">''</span>,</div><div class="line">    content: <span class="string">''</span></div><div class="line">  &#125;,</div><div class="line">  methods: &#123;</div><div class="line">    submit () &#123;</div><div class="line">    axios.post(<span class="string">'/api/posts/create'</span>,</div><div class="line">      &#123;</div><div class="line">        title: vm.title,</div><div class="line">        content: vm.content</div><div class="line">      &#125;)</div><div class="line">      .then(<span class="function"><span class="keyword">function</span>(<span class="params">response</span>) </span>&#123;</div><div class="line">        alert(<span class="built_in">JSON</span>.stringify(response.data));</div><div class="line">      &#125;)</div><div class="line">      .catch(<span class="function"><span class="keyword">function</span>(<span class="params">err</span>) </span>&#123;</div><div class="line">        alert(err);</div><div class="line">      &#125;)</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line">&#125;);</div><div class="line">&lt;<span class="regexp">/script&gt;</span></div></pre></td></tr></table></figure>
<p>在这个编辑页面利用vue技术将<input>和<textarea>标签输入的内容和data中的title和content变量进行绑定，提交按钮事件绑定到methods的submit方法。</textarea></p>
<p>axios采用post方法来发送数据，路由地址是<code>&#39;/api/posts&#39;</code>。</p>
<p>在<code>route.api.js</code>中增加路由<code>&#39;api/posts&#39;</code>的post请求处理。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/* POST posts */</span></div><div class="line">router.post(<span class="string">'/posts'</span>, <span class="function"><span class="keyword">function</span> (<span class="params">req, res, next</span>) </span>&#123;</div><div class="line">  <span class="keyword">var</span> title = req.body.title;</div><div class="line">  <span class="keyword">var</span> content = req.body.content;</div><div class="line">  res.send(&#123;title, content&#125;); <span class="comment">// 收到数据后，又把数据返回给了请求方</span></div><div class="line">&#125;);</div></pre></td></tr></table></figure>
<p>至此，我们完整构建好了从输入到接受数据的整个流程。</p>
<p>值得注意的一点。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/* GET posts lists */</span></div><div class="line">router.get(<span class="string">'/posts'</span>, <span class="function"><span class="keyword">function</span>(<span class="params">req, res, next</span>) </span>&#123;</div><div class="line">res.json(&#123;<span class="attr">postsList</span>: [<span class="string">'文章1'</span>, <span class="string">'文章2'</span>, <span class="string">'文章3'</span>]&#125;);</div><div class="line">&#125;)</div><div class="line"></div><div class="line"><span class="comment">/* POST posts */</span></div><div class="line">router.post(<span class="string">'/posts/create'</span>, <span class="function"><span class="keyword">function</span> (<span class="params">req, res, next</span>) </span>&#123;</div><div class="line">  <span class="keyword">var</span> title = req.body.title;</div><div class="line">  <span class="keyword">var</span> content = req.body.content;</div><div class="line">  res.send(&#123;title, content&#125;); <span class="comment">// 收到数据后，又把数据返回给了请求方</span></div><div class="line">&#125;);</div></pre></td></tr></table></figure>
<p>以上两个路由地址都是<code>&#39;api/posts&#39;</code>，但HTTP的请求方法不同：</p>
<ul>
<li>GET请求的<code>&#39;api/posts&#39;</code>会分发给router.get</li>
<li>POST请求的<code>&#39;api/posts&#39;</code>会分发给router.post。</li>
</ul>
<p>事实上完全可以设计不同的路由地址加以区分，但没有用HTTP的请求方法区分方便。</p>
<p>参考 <a href="https://github.com/xugy0926/learn-webapp-sample/tree/master/first-app-sample-7" target="_blank" rel="external">first-app-sample-7</a></p>
<h1 id="持久化存储-mongodb"><a href="#持久化存储-mongodb" class="headerlink" title="持久化存储 - mongodb"></a>持久化存储 - mongodb</h1><p>要把数据持久化就要用到数据库，比如sqllit，mysql，mongodb。在开发小型项目时mongodb足够用了，nodejs必须引用node-mongodb-native这个库来操作mongodb数据库，庆幸的是还可以通过mongoose。</p>
<ul>
<li>mongoose是mongodb数据库的模型工具库，专门为node.js设计</li>
<li>mongoose基于node-mongodb-native并工作在异步环境下</li>
<li>可以直接认mongoose是node-mongodb-native的拓展库</li>
<li>相比操作node-mongodb-native，操作mongoose时可以简化不少代码</li>
</ul>
<p><a href="http://mongoosejs.com/" target="_blank" rel="external">mongoose官网</a></p>
<p>以下内容只作为对操作mongodb和mongoose的认识，不需要按照本篇文档操作项目。</p>
<p>在学习操作数据库技术一般先从以下步骤进行。</p>
<ol>
<li>安装mongodb数据库。</li>
<li>通过nodejs代码连接到数据库。</li>
<li>构建模型 - 表。</li>
<li>操作表 （增、删、改、查）</li>
</ol>
<h2 id="安装mongodb"><a href="#安装mongodb" class="headerlink" title="安装mongodb"></a>安装mongodb</h2><p>在本地安装mongodb可自行google。</p>
<p>在本地安装数据库时都会污染电脑的环境，避免这种情况发生可以采用docker容器的方式来安装mongodb。</p>
<h2 id="添加mongoose"><a href="#添加mongoose" class="headerlink" title="添加mongoose"></a>添加mongoose</h2><p>在项目中添加mongoose模块</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ npm install --save mongoose</div></pre></td></tr></table></figure>
<h2 id="连接数据库"><a href="#连接数据库" class="headerlink" title="连接数据库"></a>连接数据库</h2><p>当本地运行mongodb数据后，nodejs代码要连上去非常容易。四行代码就能搞定。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">var mongoose = require(<span class="string">'mongoose'</span>);</div><div class="line"></div><div class="line">mongoose.connect(<span class="string">'mongodb://localhost:27017/firstapp'</span>, &#123;</div><div class="line">  useMongoClient: <span class="literal">true</span></div><div class="line">&#125;);</div></pre></td></tr></table></figure>
<ul>
<li>以上就是通过引入第三方模块mongoose来连接mongodb数据库。</li>
<li>数据库的端口号根据需求进行调整，一般直接安装mongodb并启动后，端口号默认是27017，如果通过docker安装，端口号会是其他的。</li>
<li>firstapp就是连接mongodb制定的数据库名，如果mongodb没有这个数据库就会新建一个。</li>
</ul>
<h2 id="定义模型-表"><a href="#定义模型-表" class="headerlink" title="定义模型 - 表"></a>定义模型 - 表</h2><figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> mongoose = <span class="built_in">require</span>(<span class="string">'mongoose'</span>);</div><div class="line"><span class="keyword">var</span> Schema = mongoose.Schema,</div><div class="line"></div><div class="line"><span class="keyword">var</span> PostSchema = <span class="keyword">new</span> Schema(&#123;</div><div class="line">    title: <span class="built_in">String</span>,</div><div class="line">    content: <span class="built_in">String</span></div><div class="line">&#125;);</div><div class="line"></div><div class="line"><span class="keyword">const</span> PostModel = mongoose.model(<span class="string">'Post'</span>, PostSchema);</div></pre></td></tr></table></figure>
<ul>
<li>通过mongoose的Schema可以构建一个表模型，在上面构建了PostSchema模型，模型有两个字段title和content。</li>
<li>将PostSchema模型关联到’Post’这张表中，如果没有Post这张表就创建一个。这种关联很有意思，假如你想在PostSchema中增加一个字段，只需要加上并重新启动应用即可，mongoose会自动帮你在数据库表中增加一个字段。</li>
</ul>
<h2 id="操作表"><a href="#操作表" class="headerlink" title="操作表"></a>操作表</h2><p>利用PostModel来操作表（增、删、查、改）</p>
<h3 id="增"><a href="#增" class="headerlink" title="增"></a>增</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> post = <span class="keyword">new</span> PostModel();</div><div class="line"></div><div class="line">post.title = title;</div><div class="line">post.content = content;</div><div class="line"></div><div class="line">post.save(<span class="function"><span class="keyword">function</span> (<span class="params">err, doc</span>) </span>&#123;</div><div class="line">  res.send(doc);</div><div class="line">&#125;);</div></pre></td></tr></table></figure>
<h3 id="删"><a href="#删" class="headerlink" title="删"></a>删</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">PostModel.remove(&#123;<span class="attr">_id</span>: postId&#125;, <span class="function"><span class="keyword">function</span> (<span class="params">err</span>) </span>&#123;</div><div class="line">  <span class="keyword">if</span> (err) handleError(err);</div><div class="line">  <span class="comment">//removed! success!</span></div><div class="line">&#125;);</div></pre></td></tr></table></figure>
<p>依据一个postId条件来删除对应的post。</p>
<h3 id="查"><a href="#查" class="headerlink" title="查"></a>查</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">PostModel.find(&#123;&#125;, <span class="function"><span class="keyword">function</span> (<span class="params">err, docs</span>) </span>&#123;</div><div class="line">  res.json(&#123; <span class="attr">postsList</span>: docs &#125;);</div><div class="line">&#125;);</div></pre></td></tr></table></figure>
<p>也可以只查制定的一个</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">PostModel.findOne(&#123;<span class="attr">_id</span>: postId&#125;, <span class="function"><span class="keyword">function</span> (<span class="params">err, doc</span>) </span>&#123;</div><div class="line">  res.json(&#123; <span class="attr">postsList</span>: docs &#125;);</div><div class="line">&#125;);</div></pre></td></tr></table></figure>
<h3 id="改"><a href="#改" class="headerlink" title="改"></a>改</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">PostModel.findOne(&#123;<span class="attr">_id</span>: postId&#125;, <span class="function"><span class="keyword">function</span> (<span class="params">err, doc</span>) </span>&#123;</div><div class="line">  <span class="keyword">if</span> (err) handleError(err);</div><div class="line">  doc.title = <span class="string">'修改标题'</span>;</div><div class="line">  doc.content = <span class="string">'修改内容'</span>;</div><div class="line">  doc.save();</div><div class="line">&#125;);</div></pre></td></tr></table></figure>
<figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">PostModel.update(&#123;<span class="attr">_id</span>: postId&#125;, &#123; <span class="attr">title</span>: <span class="string">'修改标题'</span>, <span class="attr">content</span>: <span class="string">'修改内容'</span>&#125;, <span class="function"><span class="keyword">function</span>(<span class="params">err, doc</span>) </span>&#123;</div><div class="line">  <span class="keyword">if</span> (err) handleError(err);</div><div class="line">  <span class="comment">// updated! success!</span></div><div class="line">&#125;);</div></pre></td></tr></table></figure>
<p>在操作数据库时有几点要注意。</p>
<ol>
<li>新增内容，只需要把内容填入即可。</li>
<li>删、改、查这三个操作必须给定明确的条件，否则无法操作。</li>
</ol>
<h1 id="存储数据"><a href="#存储数据" class="headerlink" title="存储数据"></a>存储数据</h1><p>先确保first-app项目已经引入了mongoose</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">$ <span class="built_in">cd</span> first-app</div><div class="line">$ npm install --save mongoose</div></pre></td></tr></table></figure>
<p>first-app在启动项目时要连接到mongodb数据库。</p>
<p>为了更好的管理模块，在first-app下新建<code>./models/init.js</code>文件</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> mongoose = <span class="built_in">require</span>(<span class="string">'mongoose'</span>);</div><div class="line"></div><div class="line">mongoose.connect(<span class="string">'mongodb://localhost:32770/firstapp'</span>, &#123;</div><div class="line">  useMongoClient: <span class="literal">true</span></div><div class="line">&#125;);</div></pre></td></tr></table></figure>
<p>该文件用于存放数据库相关的操作文件。</p>
<p><code>init.js</code>就是数据库的初始化文件，可以在<code>./app.js</code>文件最开始引入<code>init.js</code>模板。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// 在初始化app.js最开头就连接数据库</span></div><div class="line"><span class="built_in">require</span>(<span class="string">'./models/init'</span>);</div></pre></td></tr></table></figure>
<p>加载模块就会运行init.js，这样你引入的mongoose模块就连接上了数据库，后续只要操作mongoose即可。</p>
<p>新建Post模型，新建<code>./models/post.js</code>文件</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> mongoose = <span class="built_in">require</span>(<span class="string">'mongoose'</span>);</div><div class="line"><span class="keyword">var</span> Schema = mongoose.Schema;</div><div class="line"></div><div class="line"><span class="keyword">var</span> PostSchema = <span class="keyword">new</span> Schema(&#123;</div><div class="line">    title: <span class="built_in">String</span>,</div><div class="line">    content: <span class="built_in">String</span></div><div class="line">&#125;);</div><div class="line"></div><div class="line"><span class="keyword">var</span> PostModel = mongoose.model(<span class="string">'Post'</span>, PostSchema);</div><div class="line"></div><div class="line"><span class="built_in">module</span>.exports = PostModel;</div></pre></td></tr></table></figure>
<p>在<code>route.api.js</code>中</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/* 引入./models/post.js模块*/</span></div><div class="line"><span class="keyword">var</span> PostModel = <span class="built_in">require</span>(<span class="string">'./models/post'</span>);</div><div class="line"></div><div class="line"><span class="comment">/* POST create post 将数据保存到数据库的post表中 */</span></div><div class="line">router.post(<span class="string">'/posts/create'</span>, <span class="function"><span class="keyword">function</span>(<span class="params">req, res, next</span>) </span>&#123;</div><div class="line">  <span class="keyword">var</span> title = req.body.title;</div><div class="line">  <span class="keyword">var</span> content = req.body.content;</div><div class="line"></div><div class="line">  <span class="keyword">var</span> post = <span class="keyword">new</span> PostModel();</div><div class="line">  post.title = title;</div><div class="line">  post.content = content;</div><div class="line">  post.save(<span class="function"><span class="keyword">function</span> (<span class="params">err, doc</span>) </span>&#123;</div><div class="line">    res.json(&#123;<span class="attr">success</span>: <span class="literal">true</span>&#125;);</div><div class="line">  &#125;);</div><div class="line">&#125;);</div><div class="line"></div><div class="line"><span class="comment">/* GET posts lists 获取所有文章列表是从数据库查数据 */</span></div><div class="line">router.get(<span class="string">'/posts'</span>, <span class="function"><span class="keyword">function</span>(<span class="params">req, res, next</span>) </span>&#123;</div><div class="line">  PostModel.find(&#123;&#125;, &#123;&#125;, <span class="function"><span class="keyword">function</span> (<span class="params">err, posts</span>) </span>&#123;</div><div class="line">    <span class="keyword">if</span> (err) &#123;</div><div class="line">      res.json(&#123; <span class="attr">success</span>: <span class="literal">false</span> &#125;);</div><div class="line">      <span class="keyword">return</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    res.json(&#123; <span class="attr">success</span>: <span class="literal">true</span>, <span class="attr">postsList</span>: posts &#125;);</div><div class="line">  &#125;);</div><div class="line">&#125;)</div></pre></td></tr></table></figure>
<p>文档中的样子：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> express = <span class="built_in">require</span>(<span class="string">'express'</span>);</div><div class="line"><span class="keyword">var</span> router = express.Router();</div><div class="line"><span class="keyword">var</span> PostModel = <span class="built_in">require</span>(<span class="string">'./models/post'</span>);</div><div class="line"></div><div class="line"><span class="comment">/* GET users lists. */</span></div><div class="line">router.get(<span class="string">'/users'</span>, <span class="function"><span class="keyword">function</span>(<span class="params">req,res,next</span>)</span>&#123;</div><div class="line">  res.send(<span class="string">'respond with a resource'</span>);</div><div class="line">&#125;);</div><div class="line"></div><div class="line"><span class="comment">/* GET posts lists 获取所有文章列表是从数据库查数据 */</span></div><div class="line">router.get(<span class="string">'/posts'</span>, <span class="function"><span class="keyword">function</span> (<span class="params">req, res, next</span>) </span>&#123;</div><div class="line">  PostModel.find(&#123;&#125;, &#123;&#125;, <span class="function"><span class="keyword">function</span> (<span class="params">err, posts</span>) </span>&#123;</div><div class="line">    <span class="keyword">if</span> (err) &#123;</div><div class="line">      res.json(&#123; <span class="attr">success</span>: <span class="literal">false</span> &#125;);</div><div class="line">    &#125; <span class="keyword">else</span> &#123;</div><div class="line">      res.json(&#123; <span class="attr">success</span>: <span class="literal">true</span>, <span class="attr">postsList</span>: posts &#125;);</div><div class="line">    &#125;</div><div class="line">  &#125;);</div><div class="line">&#125;);</div><div class="line"></div><div class="line"></div><div class="line"><span class="comment">/* POST posts */</span></div><div class="line">router.post(<span class="string">'/posts/create'</span>, <span class="function"><span class="keyword">function</span> (<span class="params">req, res, next</span>) </span>&#123;</div><div class="line">  <span class="keyword">var</span> title = req.body.title;</div><div class="line">  <span class="keyword">var</span> content = req.body.content;</div><div class="line"></div><div class="line">  <span class="keyword">var</span> post = <span class="keyword">new</span> PostModel();</div><div class="line">  post.title = title;</div><div class="line">  post.content = content;</div><div class="line">  post.save(<span class="function"><span class="keyword">function</span> (<span class="params">err</span>) </span>&#123;</div><div class="line">    <span class="keyword">if</span> (err) &#123;</div><div class="line">      res.json(&#123;<span class="attr">success</span>: <span class="literal">false</span>&#125;);</div><div class="line">    &#125; <span class="keyword">else</span> &#123;</div><div class="line">      res.json(&#123;<span class="attr">success</span>: <span class="literal">true</span>&#125;);</div><div class="line">    &#125;</div><div class="line">  &#125;);</div><div class="line">&#125;);</div><div class="line"></div><div class="line"><span class="built_in">module</span>.exports = router;</div></pre></td></tr></table></figure>
<p>至此，从用户发送提交文章请求到保存到数据库的通路就完成了。而且api/posts路由会从数据库拉取文章列表并返回给用户。</p>
<p>因为postsList是从数据库拉取的对象数组，修改<code>./views/posts.ejs</code>：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">&lt;p v-<span class="keyword">for</span>=<span class="string">"item in postsList"</span>&gt;&#123;&#123; item.title &#125;&#125;&lt;<span class="regexp">/p&gt;</span></div></pre></td></tr></table></figure>
<p>参考 <a href="https://github.com/xugy0926/learn-webapp-sample/tree/master/first-app-sample-8" target="_blank" rel="external">first-app-sample-8</a></p>
<h1 id="显示文章详情"><a href="#显示文章详情" class="headerlink" title="显示文章详情"></a>显示文章详情</h1><p>文章列表和编辑文章都已经构建好，在补充文章详情显示即可把整个操作环路打通。</p>
<ol>
<li>设计一个显示文章详情的页面路由。</li>
</ol>
<p>我们希望用户通过以下地址访问文章<code>localhost:3000/posts/show?id=123456</code></p>
<ul>
<li><code>/posts/show</code>是路由</li>
<li>query参数id是文章的id。</li>
</ul>
<p>在<code>./route.page.js</code>中</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">router.get(<span class="string">'/posts/show'</span>, <span class="function"><span class="keyword">function</span> (<span class="params">req, res, next</span>) </span>&#123;</div><div class="line">  <span class="keyword">var</span> id = req.query.id;</div><div class="line"></div><div class="line">  PostModel.findOne(&#123;<span class="attr">_id</span>: id&#125;, <span class="function"><span class="keyword">function</span> (<span class="params">err, post</span>) </span>&#123;</div><div class="line">    res.render(<span class="string">'show'</span>, &#123;post&#125;);</div><div class="line">  &#125;);</div><div class="line">&#125;);</div></pre></td></tr></table></figure>
<ul>
<li>通过<code>req.query.id</code>可以读取url问号后面的id参数。</li>
<li>通过<code>PostModel.findOne</code>函数来查找_id等于req.query.id的post。</li>
</ul>
<ol>
<li>新建show.ejs页面</li>
</ol>
<figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line">&lt;!DOCTYPE html&gt;</div><div class="line">&lt;html&gt;</div><div class="line">  &lt;head&gt;</div><div class="line">    &lt;title&gt;&lt;%= post.title %&gt;&lt;/title&gt;</div><div class="line">    &lt;link rel=<span class="string">'stylesheet'</span> href=<span class="string">'/stylesheets/style.css'</span> /&gt;</div><div class="line">    &lt;script src=<span class="string">"https://cdn.bootcss.com/vue/2.4.4/vue.min.js"</span>&gt;&lt;/script&gt;</div><div class="line">  &lt;<span class="regexp">/head&gt;</span></div><div class="line"><span class="regexp">  &lt;body&gt;</span></div><div class="line"><span class="regexp">    &lt;div id="app"&gt;</span></div><div class="line"><span class="regexp">      &lt;h1&gt;&lt;%= post.title %&gt;&lt;/</span>h1&gt;</div><div class="line">      &lt;div&gt;&lt;%= post.content %&gt;&lt;/div&gt;</div><div class="line">    &lt;<span class="regexp">/div&gt;</span></div><div class="line"><span class="regexp">  &lt;/</span>body&gt;</div><div class="line">&lt;<span class="regexp">/html&gt;</span></div></pre></td></tr></table></figure>
<p>文档中的内容：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">&lt;!DOCTYPE html&gt;</div><div class="line">&lt;html&gt;</div><div class="line">  &lt;head&gt;</div><div class="line">    &lt;link rel=<span class="string">'stylesheet'</span> href=<span class="string">'/stylesheets/style.css'</span> /&gt;</div><div class="line">    &lt;link href=<span class="string">"https://cdn.bootcss.com/bootstrap/3.3.6/css/bootstrap.min.css"</span> rel=<span class="string">"stylesheet"</span>&gt;</div><div class="line">  &lt;<span class="regexp">/head&gt;</span></div><div class="line"><span class="regexp">  &lt;body&gt;</span></div><div class="line"><span class="regexp">    &lt;div id="app"&gt;</span></div><div class="line"><span class="regexp">      &lt;h1&gt;&lt;%= post.title %&gt;&lt;/</span>h1&gt;</div><div class="line">      &lt;div&gt;&lt;%= post.content %&gt;&lt;/div&gt;</div><div class="line">    &lt;<span class="regexp">/div&gt;</span></div><div class="line"><span class="regexp">  &lt;/</span>body&gt;</div><div class="line">&lt;<span class="regexp">/html&gt;</span></div></pre></td></tr></table></figure>
<ul>
<li>因为<code>res.render(&#39;show&#39;, {post})</code>传入的数据是一个post对象，因此在<code>show.ejs</code>中解析数据时要用<code>post.title</code>和<code>post.content</code>来填充内容。</li>
</ul>
<ol>
<li>从文章列表点击跳转到文章详情，只需要在<code>post.ejs</code>中把列表加上<a>跳转即可。</a></li>
</ol>
<figure class="highlight html"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">v-for</span>=<span class="string">"item in postsList"</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">a</span> <span class="attr">v-bind:href</span>=<span class="string">"item.url"</span>&gt;</span>&#123;&#123; item.title &#125;&#125;<span class="tag">&lt;/<span class="name">a</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></div></pre></td></tr></table></figure>
<p>在请求数据得到结果后，为每个item加上url字段</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="undefined"></span></div><div class="line"><span class="javascript">  <span class="keyword">var</span> vm = <span class="keyword">new</span> Vue(&#123;</span></div><div class="line"><span class="javascript">    el: <span class="string">'#app'</span>,</span></div><div class="line"><span class="undefined">    data: &#123;</span></div><div class="line"><span class="undefined">      postsList: []</span></div><div class="line"><span class="undefined">    &#125;,</span></div><div class="line"><span class="undefined">    methods: &#123;</span></div><div class="line"><span class="undefined">      fetchData () &#123;</span></div><div class="line"><span class="javascript">        axios.get(<span class="string">'/api/posts'</span>)</span></div><div class="line"><span class="javascript">          .then(<span class="function"><span class="keyword">function</span>(<span class="params">response</span>) </span>&#123;</span></div><div class="line"><span class="undefined">            vm.postsList = response.data.postsList;</span></div><div class="line"><span class="javascript">            vm.postsList.forEach(<span class="function">(<span class="params">element</span>) =&gt;</span> element.url = <span class="string">'/posts/show?id='</span> + element._id);</span></div><div class="line"><span class="undefined">          &#125;)</span></div><div class="line"><span class="undefined">      &#125;</span></div><div class="line"><span class="undefined">    &#125;</span></div><div class="line"><span class="undefined">  &#125;);</span></div><div class="line"><span class="undefined">  </span></div><div class="line"><span class="undefined">  vm.fetchData();</span></div><div class="line"><span class="undefined"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></div></pre></td></tr></table></figure>
<p>参考 <a href="https://github.com/xugy0926/learn-webapp-sample/tree/master/first-app-sample-9" target="_blank" rel="external">first-app-sample-9</a></p>
<h1 id="处理markdown"><a href="#处理markdown" class="headerlink" title="处理markdown"></a>处理markdown</h1><p>在nodejs中处理markdown格式非常简单，只需要一个第三方提供的翻译库即可。比如 <a href="https://github.com/chjj/marked" target="_blank" rel="external">marked</a> 或 <a href="https://github.com/markdown-it/markdown-it" target="_blank" rel="external">markdown-it</a>。</p>
<p>markdown 的简单原理：</p>
<ul>
<li>书写 markdown 文档很像在写 html，它们属于标记语言，但 markdown 的书写更简单。</li>
<li>markdown格式最终会通过翻译器翻译成html<ul>
<li><code># title</code>被翻译成<code>&lt;h1&gt;title&lt;h1&gt;</code></li>
<li><code>## subtitle</code>被翻译成<code>&lt;h2&gt;subtitle&lt;h2&gt;</code></li>
</ul>
</li>
<li><a href="http://www.appinn.com/markdown/basic.html" target="_blank" rel="external">详细的markdown语法</a></li>
</ul>
<p>下面就以第三方库marked为例说明：</p>
<h2 id="安装marked"><a href="#安装marked" class="headerlink" title="安装marked"></a>安装marked</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">npm install marked --save</div></pre></td></tr></table></figure>
<h2 id="利用marked将md内容转化成html内容"><a href="#利用marked将md内容转化成html内容" class="headerlink" title="利用marked将md内容转化成html内容"></a>利用marked将md内容转化成html内容</h2><figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> marked = <span class="built_in">require</span>(<span class="string">'marked'</span>);</div><div class="line"><span class="keyword">var</span> mdContent = <span class="string">'# title'</span>;</div><div class="line"><span class="keyword">var</span> htmlContent = marked(mdContent);</div><div class="line"><span class="built_in">console</span>.log(htmlContent);</div><div class="line"></div><div class="line"><span class="comment">// output: &lt;h1&gt;title&lt;/h1&gt;</span></div></pre></td></tr></table></figure>
<p>以上是官方给出的例子。</p>
<h2 id="在first-app项目中引入marked模块"><a href="#在first-app项目中引入marked模块" class="headerlink" title="在first-app项目中引入marked模块"></a>在first-app项目中引入marked模块</h2><p><code>route.page.js</code></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> marked = <span class="built_in">require</span>(<span class="string">'marked'</span>);</div></pre></td></tr></table></figure>
<p>在res.render页面之前，先把post.content内容转化成html</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">router.get(<span class="string">'/posts/show'</span>, <span class="function"><span class="keyword">function</span> (<span class="params">req, res, next</span>) </span>&#123;</div><div class="line">  <span class="keyword">var</span> id = req.query.id;</div><div class="line"></div><div class="line">  PostModel.findOne(&#123; <span class="attr">_id</span>: id &#125;, <span class="function"><span class="keyword">function</span> (<span class="params">err, post</span>) </span>&#123;</div><div class="line">    post.mkContent = marked(post.content);</div><div class="line">    res.render(<span class="string">'show'</span>, &#123;post&#125;);</div><div class="line">  &#125;);</div><div class="line">&#125;);</div></pre></td></tr></table></figure>
<p>在<code>show.ejs</code>中，post的content内容已经被转换成html了</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">&lt;div&gt;</div><div class="line">  &lt;h1&gt;<span class="xml"><span class="tag">&lt;<span class="name">%=</span> <span class="attr">post.title</span> %&gt;</span><span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span></div><div class="line">  &lt;div&gt;<span class="xml"><span class="tag">&lt;<span class="name">%-</span> <span class="attr">post.mkContent</span> %&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></div><div class="line">&lt;<span class="regexp">/div&gt;</span></div></pre></td></tr></table></figure>
<p><code>&lt;%- %&gt;</code>会把内容当成html来显示。</p>
<p>参考 <a href="https://github.com/xugy0926/learn-webapp-sample/tree/master/first-app-sample-10" target="_blank" rel="external">first-app-sample-10</a></p>
<hr>
<h1 id="设计页面跳转"><a href="#设计页面跳转" class="headerlink" title="设计页面跳转"></a>设计页面跳转</h1><p>通过前面的小节，first-webapp已 具备以下路由和功能。</p>
<h2 id="页面"><a href="#页面" class="headerlink" title="页面"></a>页面</h2><table>
<thead>
<tr>
<th>路由</th>
<th>功能</th>
</tr>
</thead>
<tbody>
<tr>
<td>[GET] /</td>
<td>主页面</td>
</tr>
<tr>
<td>[GET] /posts</td>
<td>文章列表页面</td>
</tr>
<tr>
<td>[GET] /posts/create</td>
<td>创建文章页面</td>
</tr>
<tr>
<td>[GET] /posts/show</td>
<td>显示文章页面</td>
</tr>
</tbody>
</table>
<h2 id="API"><a href="#API" class="headerlink" title="API"></a>API</h2><table>
<thead>
<tr>
<th>路由</th>
<th>功能</th>
</tr>
</thead>
<tbody>
<tr>
<td>[GET] /api/users</td>
<td>创建项目时自带的功能（暂时留着）</td>
</tr>
<tr>
<td>[GET] /api/posts</td>
<td>获取文章列表</td>
</tr>
<tr>
<td>[POST] /api/posts/create</td>
<td>提交新文章</td>
</tr>
</tbody>
</table>
<p>本节将对页面的结构进行串联，以达到更好的用户体验。</p>
<p>当要设计一个类似博客的客户端时，进入主页后，可以设计一个个人宣传页面，从个人宣传页面点击后进入到文章列表页面。文章列表页面不仅展示文章的列表，还会提供发表文章。点击文章列表的某个文章标题，可以直接进入到文章详情。</p>
<p><a href="https://github.com/you7588/learn-webapp-guideline/blob/master/assets/pages-jump.png" target="_blank" rel="external"><img src="https://github.com/you7588/learn-webapp-guideline/raw/master/assets/pages-jump.png" alt="img"></a></p>
<p>通过以上的交互，可以保证整个交互是通顺的。</p>
<h2 id="跳转设计"><a href="#跳转设计" class="headerlink" title="跳转设计"></a>跳转设计</h2><h3 id="在views-index-ejs中，引入bootstrap的巨幕样式："><a href="#在views-index-ejs中，引入bootstrap的巨幕样式：" class="headerlink" title="在views/index.ejs中，引入bootstrap的巨幕样式："></a>在<code>views/index.ejs</code>中，引入bootstrap的<a href="http://v3.bootcss.com/components/#jumbotron" target="_blank" rel="external">巨幕</a>样式：</h3><figure class="highlight html"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">title</span>&gt;</span><span class="tag">&lt;<span class="name">%=</span> <span class="attr">title</span> %&gt;</span><span class="tag">&lt;/<span class="name">title</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">link</span> <span class="attr">href</span>=<span class="string">"https://cdn.bootcss.com/bootstrap/3.3.6/css/bootstrap.min.css"</span> <span class="attr">rel</span>=<span class="string">"stylesheet"</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">link</span> <span class="attr">rel</span>=<span class="string">'stylesheet'</span> <span class="attr">href</span>=<span class="string">'/stylesheets/style.css'</span> /&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></div></pre></td></tr></table></figure>
<h3 id="在主页views-index-ejs增加巨幕样式："><a href="#在主页views-index-ejs增加巨幕样式：" class="headerlink" title="在主页views/index.ejs增加巨幕样式："></a>在主页<code>views/index.ejs</code>增加巨幕样式：</h3><figure class="highlight html"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"container"</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"col-md-8 col-md-offset-2"</span>&gt;</span></div><div class="line">      <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"jumbotron"</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">h1</span>&gt;</span>Hello, world!<span class="tag">&lt;/<span class="name">h1</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">p</span>&gt;</span>这是我记忆空间。<span class="tag">&lt;/<span class="name">p</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">p</span>&gt;</span><span class="tag">&lt;<span class="name">a</span> <span class="attr">class</span>=<span class="string">"btn btn-primary btn-lg"</span> <span class="attr">href</span>=<span class="string">"/posts"</span> <span class="attr">role</span>=<span class="string">"button"</span>&gt;</span>进入新世界<span class="tag">&lt;/<span class="name">a</span>&gt;</span><span class="tag">&lt;/<span class="name">p</span>&gt;</span></div><div class="line">      <span class="tag">&lt;/<span class="name">div</span>&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></div><div class="line">  <span class="tag">&lt;/<span class="name">div</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></div></pre></td></tr></table></figure>
<h3 id="改全局-lt-body-gt-的背景"><a href="#改全局-lt-body-gt-的背景" class="headerlink" title="改全局 &lt;body&gt; 的背景"></a>改全局 <code>&lt;body&gt;</code> 的背景</h3><p>在全局 body 里添加background，给所有页面添加一个背景图片，以保证页面更好看一些。</p>
<p><code>public/stylesheets/style.css</code></p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="selector-tag">body</span> &#123;</div><div class="line">  <span class="attribute">padding</span>: <span class="number">50px</span>;</div><div class="line">  <span class="attribute">font</span>: <span class="number">14px</span> <span class="string">"Lucida Grande"</span>, Helvetica, Arial, sans-serif;</div><div class="line">  <span class="attribute">background</span>: <span class="number">#E6CCA6</span> <span class="built_in">url</span>(../images/bg.png) repeat fixed;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="修改文章列表样式"><a href="#修改文章列表样式" class="headerlink" title="修改文章列表样式"></a>修改文章列表样式</h3><p><code>views/posts.ejs</code></p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">ul</span> <span class="attr">class</span>=<span class="string">"list-group"</span> <span class="attr">v-for</span>=<span class="string">"item in postsList"</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">li</span> <span class="attr">class</span>=<span class="string">"list-group-item"</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">a</span> <span class="attr">v-bind:href</span>=<span class="string">"item.url"</span>&gt;</span>&#123;&#123; item.title &#125;&#125;<span class="tag">&lt;/<span class="name">a</span>&gt;</span></div><div class="line">  <span class="tag">&lt;/<span class="name">li</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">ul</span>&gt;</span></div></pre></td></tr></table></figure>
<p>用 bootstrap中的 <a href="http://v3.bootcss.com/components/#list-group" target="_blank" rel="external">list-group</a> 组件来展示文章的列表</p>
<h3 id="在文章列表添加新建文章的按钮"><a href="#在文章列表添加新建文章的按钮" class="headerlink" title="在文章列表添加新建文章的按钮"></a>在文章列表添加新建文章的按钮</h3><p>案例使用的是<a href="http://v3.bootcss.com/components/#btn-groups" target="_blank" rel="external">分列式下拉菜单按钮</a></p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="comment">&lt;!-- Split button --&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"btn-group pull-right"</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">button</span> <span class="attr">type</span>=<span class="string">"button"</span> <span class="attr">class</span>=<span class="string">"btn btn-default"</span>&gt;</span>操作<span class="tag">&lt;/<span class="name">button</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">button</span> <span class="attr">type</span>=<span class="string">"button"</span> <span class="attr">class</span>=<span class="string">"btn btn-default dropdown-toggle"</span> <span class="attr">data-toggle</span>=<span class="string">"dropdown"</span> <span class="attr">aria-haspopup</span>=<span class="string">"true"</span> <span class="attr">aria-expanded</span>=<span class="string">"false"</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">span</span> <span class="attr">class</span>=<span class="string">"caret"</span>&gt;</span><span class="tag">&lt;/<span class="name">span</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">span</span> <span class="attr">class</span>=<span class="string">"sr-only"</span>&gt;</span>Toggle Dropdown<span class="tag">&lt;/<span class="name">span</span>&gt;</span></div><div class="line">  <span class="tag">&lt;/<span class="name">button</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">ul</span> <span class="attr">class</span>=<span class="string">"dropdown-menu"</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">li</span>&gt;</span><span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">"/posts/create"</span>&gt;</span>新建<span class="tag">&lt;/<span class="name">a</span>&gt;</span><span class="tag">&lt;/<span class="name">li</span>&gt;</span></div><div class="line">  <span class="tag">&lt;/<span class="name">ul</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></div></pre></td></tr></table></figure>
<p>分列式菜单想正确显示，必须引入jquery.js 和 bootstrap.js</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">"https://cdn.bootcss.com/jquery/2.2.4/jquery.min.js"</span>&gt;</span><span class="undefined"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">"https://cdn.bootcss.com/bootstrap/3.3.6/js/bootstrap.min.js"</span>&gt;</span><span class="undefined"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></div></pre></td></tr></table></figure>
<h3 id="调整编辑页面布局"><a href="#调整编辑页面布局" class="headerlink" title="调整编辑页面布局"></a>调整编辑页面布局</h3><p><code>views/create.ejs</code></p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"container"</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"col-md-8 col-md-offset-2"</span>&gt;</span></div><div class="line">  ......</div><div class="line">  <span class="tag">&lt;/<span class="name">div</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></div></pre></td></tr></table></figure>
<h3 id="调整文章显示页面布局"><a href="#调整文章显示页面布局" class="headerlink" title="调整文章显示页面布局"></a>调整文章显示页面布局</h3><p><code>views/show.ejs</code></p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"container"</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"col-md-8 col-md-offset-2"</span>&gt;</span></div><div class="line">  ......</div><div class="line">  <span class="tag">&lt;/<span class="name">div</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></div></pre></td></tr></table></figure>
<p>参考事例 <a href="https://github.com/xugy0926/learn-webapp-sample/tree/master/first-app-sample-11" target="_blank" rel="external">first-app-sample-11</a></p>
<h1 id="编辑文章"><a href="#编辑文章" class="headerlink" title="编辑文章"></a>编辑文章</h1><p>创建文章后，都会提供再编辑文章的功能。这个功能需要设计两个路由。一个用户访问编辑页面，另一个用于提交修改信息。</p>
<h2 id="页面-1"><a href="#页面-1" class="headerlink" title="页面"></a>页面</h2><table>
<thead>
<tr>
<th>路由</th>
<th>功能</th>
</tr>
</thead>
<tbody>
<tr>
<td>[GET] /posts/edit</td>
<td>编辑页面</td>
</tr>
</tbody>
</table>
<h2 id="API-1"><a href="#API-1" class="headerlink" title="API"></a>API</h2><table>
<thead>
<tr>
<th>路由</th>
<th>功能</th>
</tr>
</thead>
<tbody>
<tr>
<td>[POST] /api/posts/edit</td>
<td>提交文章修改内容</td>
</tr>
<tr>
<td>[GET] /api/posts/one</td>
<td>获取特定文章的内容</td>
</tr>
</tbody>
</table>
<h2 id="添加页面路由处理逻辑"><a href="#添加页面路由处理逻辑" class="headerlink" title="添加页面路由处理逻辑"></a>添加页面路由处理逻辑</h2><h3 id="添加编辑按钮"><a href="#添加编辑按钮" class="headerlink" title="添加编辑按钮"></a>添加编辑按钮</h3><p>在 <code>views/show.ejs</code> 中添加编辑按钮，用于触发打开编辑页面。</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="comment">&lt;!-- Split button --&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"btn-group pull-right"</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">button</span> <span class="attr">type</span>=<span class="string">"button"</span> <span class="attr">class</span>=<span class="string">"btn btn-default"</span>&gt;</span>操作<span class="tag">&lt;/<span class="name">button</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">button</span> <span class="attr">type</span>=<span class="string">"button"</span> <span class="attr">class</span>=<span class="string">"btn btn-default dropdown-toggle"</span> <span class="attr">data-toggle</span>=<span class="string">"dropdown"</span> <span class="attr">aria-haspopup</span>=<span class="string">"true"</span> <span class="attr">aria-expanded</span>=<span class="string">"false"</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">span</span> <span class="attr">class</span>=<span class="string">"caret"</span>&gt;</span><span class="tag">&lt;/<span class="name">span</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">span</span> <span class="attr">class</span>=<span class="string">"sr-only"</span>&gt;</span>Toggle Dropdown<span class="tag">&lt;/<span class="name">span</span>&gt;</span></div><div class="line">  <span class="tag">&lt;/<span class="name">button</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">ul</span> <span class="attr">class</span>=<span class="string">"dropdown-menu"</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">li</span>&gt;</span><span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">"/posts/edit?id=&lt;%= post._id %&gt;"</span>&gt;</span>编辑<span class="tag">&lt;/<span class="name">a</span>&gt;</span><span class="tag">&lt;/<span class="name">li</span>&gt;</span></div><div class="line">  <span class="tag">&lt;/<span class="name">ul</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></div></pre></td></tr></table></figure>
<h3 id="增加访问编辑页面逻辑"><a href="#增加访问编辑页面逻辑" class="headerlink" title="增加访问编辑页面逻辑"></a>增加访问编辑页面逻辑</h3><p>在 <code>route.page.js</code> 中添加对 <code>/posts/edit</code>的处理。</p>
<p>访问编辑页面的路由需要带一个query参数id。<code>posts/edit?id=xxxx</code></p>
<p>因此需要通过req.query对象取出id。取出的id直接给到edit页面。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/* GET posts edit page. */</span></div><div class="line">router.get(<span class="string">'/posts/edit'</span>, <span class="function"><span class="keyword">function</span> (<span class="params">req, res, next</span>) </span>&#123;</div><div class="line">  <span class="keyword">var</span> id = req.query.id;</div><div class="line"></div><div class="line">  res.render(<span class="string">'edit'</span>, &#123; id &#125;);</div><div class="line">&#125;);</div></pre></td></tr></table></figure>
<h3 id="添加获取某个特定id的文章"><a href="#添加获取某个特定id的文章" class="headerlink" title="添加获取某个特定id的文章"></a>添加获取某个特定id的文章</h3><p>在<code>route.api.js</code> 中添加 <code>/posts/one</code>的路由处理。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/* GET one post */</span></div><div class="line">router.get(<span class="string">'/posts/one'</span>, <span class="function"><span class="keyword">function</span> (<span class="params">req, res, next</span>) </span>&#123;</div><div class="line">  <span class="keyword">var</span> id = req.query.id;</div><div class="line"></div><div class="line">  PostModel.findOne(&#123;<span class="attr">_id</span>: id&#125;, <span class="function"><span class="keyword">function</span>(<span class="params">err, post</span>) </span>&#123;</div><div class="line">    <span class="keyword">if</span> (err) &#123;</div><div class="line">      res.json(&#123; <span class="attr">success</span>: <span class="literal">false</span> &#125;);</div><div class="line">      <span class="keyword">return</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    res.json(&#123; <span class="attr">success</span>: <span class="literal">true</span>, post &#125;);</div><div class="line">  &#125;);</div><div class="line">&#125;);</div></pre></td></tr></table></figure>
<h3 id="添加编辑更新某个特定id的文章"><a href="#添加编辑更新某个特定id的文章" class="headerlink" title="添加编辑更新某个特定id的文章"></a>添加编辑更新某个特定id的文章</h3><p>使用findOneAndUpdate更新数据，第二个参数 title和content表示要更新的字段。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/* PATCH edit post */</span></div><div class="line">router.post(<span class="string">'/posts/edit'</span>, <span class="function"><span class="keyword">function</span>(<span class="params">req, res, next</span>) </span>&#123;</div><div class="line">  <span class="keyword">var</span> id = req.body.id;</div><div class="line">  <span class="keyword">var</span> title = req.body.title;</div><div class="line">  <span class="keyword">var</span> content = req.body.content;</div><div class="line"></div><div class="line">  PostModel.findOneAndUpdate(&#123; <span class="attr">_id</span>: id &#125;, &#123; title, content &#125;, <span class="function"><span class="keyword">function</span>(<span class="params">err</span>) </span>&#123;</div><div class="line">    <span class="keyword">if</span> (err) &#123;</div><div class="line">      res.json(&#123; <span class="attr">success</span>: <span class="literal">false</span> &#125;);</div><div class="line">    &#125; <span class="keyword">else</span> &#123;</div><div class="line">      res.json(&#123; <span class="attr">success</span>: <span class="literal">true</span> &#125;);</div><div class="line">    &#125;</div><div class="line">  &#125;);</div><div class="line">&#125;);</div></pre></td></tr></table></figure>
<h3 id="添加编辑页面"><a href="#添加编辑页面" class="headerlink" title="添加编辑页面"></a>添加编辑页面</h3><p>新建 <code>views/edit.ejs</code>, 内容可以从<code>views/create.ejs</code>中拷贝过来。但在 <code>&lt;script&gt;</code> 中要做一些调整。</p>
<p>获取文章id，id 是 在render页面时传给页面的。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> postId = <span class="string">'&lt;%= id %&gt;'</span>;</div></pre></td></tr></table></figure>
<blockquote>
<p> 在<code>&lt;script&gt;</code>中要利用res.render传过来的变量，一样是使用&lt;%= %&gt;标签，在解释是会直接把id的值替换上去。</p>
</blockquote>
<p>Vue初始化是在created()回调中直接抓取文章数据，并把内容给到 Vue的data中的title和content。</p>
<p>修改submit方法，提交并存储更改后的内容，记得把文章id传递过去。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div></pre></td><td class="code"><pre><div class="line">created () &#123;</div><div class="line">  axios.get(<span class="string">'/api/posts/one?id='</span> + postId)</div><div class="line">    .then(<span class="function"><span class="keyword">function</span>(<span class="params">response</span>) </span>&#123;</div><div class="line">      vm.title = response.data.post.title;</div><div class="line">      vm.content = response.data.post.content;</div><div class="line">    &#125;)</div><div class="line">    .catch(<span class="function"><span class="keyword">function</span>(<span class="params">err</span>) </span>&#123;</div><div class="line">      alert(err);</div><div class="line">    &#125;)</div><div class="line">&#125;,</div><div class="line">  methods: &#123;</div><div class="line">    submit () &#123;</div><div class="line">    axios.post(<span class="string">'/api/posts/edit'</span>,</div><div class="line">      &#123;</div><div class="line">        id: postId,</div><div class="line">        title: vm.title,</div><div class="line">        content: vm.content</div><div class="line">      &#125;)</div><div class="line">      .then(<span class="function"><span class="keyword">function</span>(<span class="params">response</span>) </span>&#123;</div><div class="line">        alert(<span class="built_in">JSON</span>.stringify(response.data));</div><div class="line">      &#125;)</div><div class="line">      .catch(<span class="function"><span class="keyword">function</span>(<span class="params">err</span>) </span>&#123;</div><div class="line">        alert(err);</div><div class="line">      &#125;)</div><div class="line">    &#125;</div><div class="line">  &#125;</div></pre></td></tr></table></figure>
<p>这样就保证html加载时，回去根据id抓取文章内容。</p>
<p>参考事例 <a href="https://github.com/xugy0926/learn-webapp-sample/tree/master/first-app-sample-12" target="_blank" rel="external">first-app-sample-12</a></p>
<h1 id="页面模板"><a href="#页面模板" class="headerlink" title="页面模板"></a>页面模板</h1><p>以下是前面构建的所有页面。</p>
<table>
<thead>
<tr>
<th>页面</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td>views/create.ejs</td>
<td>新建文章页面</td>
</tr>
<tr>
<td>views/edit.ejs</td>
<td>编辑文章页面</td>
</tr>
<tr>
<td>views/index.ejs</td>
<td>主页面</td>
</tr>
<tr>
<td>views/posts.ejs</td>
<td>文章列表页面</td>
</tr>
<tr>
<td>views/show.ejs</td>
<td>显示文章页面</td>
</tr>
</tbody>
</table>
<p>这些页面都是独立的html页面，随着业务的复杂，不断的添加页面，意味着要不断的新建页面。有没有发现一个问题，每个页面很多内容是重复的，比如<code>&lt;html&gt;&lt;head&gt;&lt;body&gt;</code>。</p>
<p>一定要想出一个办法构建一个公共的页面，公共页面包涵了html的主结构<code>&lt;html&gt;&lt;head&gt;&lt;body&gt;</code>。其他各个页面的主要内容嵌入到里面即可。</p>
<p>（TODO：这里要补一张图）</p>
<h2 id="引入express-ejs-layouts"><a href="#引入express-ejs-layouts" class="headerlink" title="引入express-ejs-layouts"></a>引入express-ejs-layouts</h2><h3 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ npm install --save express-ejs-layouts</div></pre></td></tr></table></figure>
<h3 id="引入"><a href="#引入" class="headerlink" title="引入"></a>引入</h3><p>在app.js中引入express-ejs-layouts</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> expressLayouts = <span class="built_in">require</span>(<span class="string">'express-ejs-layouts'</span>);</div></pre></td></tr></table></figure>
<h3 id="使用"><a href="#使用" class="headerlink" title="使用"></a>使用</h3><p>在 app.js 设置完view engine后，使用 expressLayouts</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// view engine setup</span></div><div class="line">app.set(<span class="string">'views'</span>, path.join(__dirname, <span class="string">'views'</span>));</div><div class="line">app.set(<span class="string">'view engine'</span>, <span class="string">'ejs'</span>);</div><div class="line">app.use(expressLayouts);</div></pre></td></tr></table></figure>
<h3 id="创建全局模板"><a href="#创建全局模板" class="headerlink" title="创建全局模板"></a>创建全局模板</h3><p>新建 views/layout.ejs。</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line"><span class="meta">&lt;!DOCTYPE html&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">head</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">link</span> <span class="attr">rel</span>=<span class="string">"stylesheet"</span> <span class="attr">href</span>=<span class="string">"https://cdn.bootcss.com/bootstrap/3.3.6/css/bootstrap.min.css"</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">link</span> <span class="attr">rel</span>=<span class="string">"stylesheet"</span> <span class="attr">href</span>=<span class="string">'/stylesheets/style.css'</span> /&gt;</span></div><div class="line"></div><div class="line">    <span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">"https://cdn.bootcss.com/jquery/2.2.4/jquery.min.js"</span>&gt;</span><span class="undefined"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">"https://cdn.bootcss.com/bootstrap/3.3.6/js/bootstrap.min.js"</span>&gt;</span><span class="undefined"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">"https://cdn.bootcss.com/vue/2.4.4/vue.min.js"</span>&gt;</span><span class="undefined"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">"https://cdn.bootcss.com/axios/0.16.2/axios.min.js"</span>&gt;</span><span class="undefined"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></div><div class="line">  <span class="tag">&lt;/<span class="name">head</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">body</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">"app"</span>&gt;</span></div><div class="line">      <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"container"</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">%-</span> <span class="attr">body</span> %&gt;</span></div><div class="line">      <span class="tag">&lt;/<span class="name">div</span>&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></div><div class="line">  <span class="tag">&lt;/<span class="name">body</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></div></pre></td></tr></table></figure>
<h3 id="修改其余页面"><a href="#修改其余页面" class="headerlink" title="修改其余页面"></a>修改其余页面</h3><p>比如在 views/index.ejs 中，可以去掉多余的标签，只关心这个页面核心内容。</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"col-md-8 col-md-offset-2"</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"jumbotron"</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">h1</span>&gt;</span>Hello, world!<span class="tag">&lt;/<span class="name">h1</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">p</span>&gt;</span>这是我记忆空间。<span class="tag">&lt;/<span class="name">p</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">p</span>&gt;</span><span class="tag">&lt;<span class="name">a</span> <span class="attr">class</span>=<span class="string">"btn btn-primary btn-lg"</span> <span class="attr">href</span>=<span class="string">"/posts"</span> <span class="attr">role</span>=<span class="string">"button"</span>&gt;</span>进入新世界<span class="tag">&lt;/<span class="name">a</span>&gt;</span><span class="tag">&lt;/<span class="name">p</span>&gt;</span></div><div class="line">  <span class="tag">&lt;/<span class="name">div</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></div></pre></td></tr></table></figure>
<p>其余页面的修改类似和 views/index.ejs 类似。</p>
<p>参考事例 <a href="https://github.com/xugy0926/learn-webapp-sample/tree/master/first-app-sample-13" target="_blank" rel="external">first-app-sample-13</a></p>
<h1 id="更好的API能力"><a href="#更好的API能力" class="headerlink" title="更好的API能力"></a>更好的API能力</h1><p>开发一个WebApp项目，项目能力全部体现路由上，路由可以称为WebApp提供给外界的API。</p>
<h2 id="API-2"><a href="#API-2" class="headerlink" title="API"></a>API</h2><table>
<thead>
<tr>
<th>路由</th>
<th>功能</th>
</tr>
</thead>
<tbody>
<tr>
<td>[GET] /api/users</td>
<td>创建项目时自带的功能（暂时留着）</td>
</tr>
<tr>
<td>[GET] /api/posts</td>
<td>获取文章列表</td>
</tr>
<tr>
<td>[POST] /api/posts/create</td>
<td>提交新文章</td>
</tr>
<tr>
<td>[POST] /api/posts/edit</td>
<td>提交文章修改内容</td>
</tr>
<tr>
<td>[GET] /api/posts/one</td>
<td>获取特定文章的内容</td>
</tr>
</tbody>
</table>
<h2 id="路由分类"><a href="#路由分类" class="headerlink" title="路由分类"></a>路由分类</h2><p>前面我们将获取页面的路由和获取数据的路由进行了分类，这是一个极好的习惯。这其实是业务上的分类，不仅是对功能切分，在分工上可以有不同的工程师来分别维护两者。</p>
<h2 id="API版本控制"><a href="#API版本控制" class="headerlink" title="API版本控制"></a>API版本控制</h2><p>有些时候我们还可以对api进行版本分类，以更好的升级api。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">[GET] /api/v1/users</div><div class="line">[GET] /api/v1/posts</div><div class="line">[POST] /api/v1/posts/create</div><div class="line">[POST] /api/v1/posts/edit</div><div class="line">[GET] /api/v1/posts/one</div></pre></td></tr></table></figure>
<p>在未来，你可以针对某个路由进行升级。比如下面单独升级/api/v1/posts/one 为 v2。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">[GET] /api/v1/users</div><div class="line">[GET] /api/v1/posts</div><div class="line">[POST] /api/v1/posts/create</div><div class="line">[POST] /api/v1/posts/edit</div><div class="line">[GET] /api/v2/posts/one</div></pre></td></tr></table></figure>
<h2 id="尽可能用http自身的方法来区分路由功能"><a href="#尽可能用http自身的方法来区分路由功能" class="headerlink" title="尽可能用http自身的方法来区分路由功能"></a>尽可能用http自身的方法来区分路由功能</h2><p>http提供了很多方法，和数据有关的有以下几类。</p>
<ul>
<li>GET（SELECT）：从服务器取出资源（一项或多项）。</li>
<li>POST（CREATE）：在服务器新建一个资源。</li>
<li>PUT（UPDATE）：在服务器更新资源（客户端提供改变后的完整资源）。</li>
<li>PATCH（UPDATE）：在服务器更新资源（客户端提供改变的属性）。</li>
<li>DELETE（DELETE）：从服务器删除资源。</li>
</ul>
<p>依据这个原则，我们把API调整如下。</p>
<ul>
<li>[GET] /api/v1/users</li>
<li>[GET] /api/v1/posts</li>
<li>[POST] /api/v1/posts/create</li>
<li>[PATCH] /api/v1/posts/edit</li>
<li>[GET] /api/v1/posts/one</li>
</ul>
<h2 id="避免使用动词来区分路由"><a href="#避免使用动词来区分路由" class="headerlink" title="避免使用动词来区分路由"></a>避免使用动词来区分路由</h2><p>在上面用了create，edit这样的字眼，路由尽量避免。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">[GET] /api/v1/users</div><div class="line">[GET] /api/v1/posts  </div><div class="line">[POST] /api/v1/posts // 去掉动词</div><div class="line">[PATCH] /api/v1/posts  // 去掉动词</div><div class="line">[GET] /api/v1/posts/one</div></pre></td></tr></table></figure>
<p>对posts这个资源，通过http的GET，POST，PUT三个方法就能区分是做什么事情，不需要多余的动词加以区分。</p>
<h2 id="用资源ID而不是单词区分资源"><a href="#用资源ID而不是单词区分资源" class="headerlink" title="用资源ID而不是单词区分资源"></a>用资源ID而不是单词区分资源</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">[GET] /api/v1/posts  // 获取文章列表</div><div class="line">[GET] /api/v1/posts/one // 获取某一个文章</div></pre></td></tr></table></figure>
<p>改成</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">[GET] /api/v1/posts  // 获取文章列表</div><div class="line">[GET] /api/v1/posts/:id // 获取某一个文章</div></pre></td></tr></table></figure>
<h2 id="最终的路由"><a href="#最终的路由" class="headerlink" title="最终的路由"></a>最终的路由</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">[GET] /api/v1/users</div><div class="line">[GET] /api/v1/posts  </div><div class="line">[POST] /api/v1/posts</div><div class="line">[PATCH] /api/v1/posts/:id</div><div class="line">[GET] /api/v1/posts/:id</div></pre></td></tr></table></figure>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><ol>
<li>尽量用http的方法来区分功能。</li>
<li>避免在路由上用动词区分功能。</li>
<li>针对某个资源，用和该资源有关的id（或唯一值）</li>
</ol>
<p>以上我们整理和数据有关的API，数据API属于服务端范畴，页面只能用唯一的HTTP的GET方法，而且页面是属于客户端范畴。因此，页面的路由设计相对宽容一些。在教程中并不做专门的讲解。</p>
<p><a href="http://www.ruanyifeng.com/blog/2014/05/restful_api.html" target="_blank" rel="external">restfull api设计指南</a></p>
<p>参考事例 <a href="https://github.com/xugy0926/learn-webapp-sample/tree/master/first-app-sample-14" target="_blank" rel="external">first-app-sample-14</a></p>
<h1 id="更好的结果处理"><a href="#更好的结果处理" class="headerlink" title="更好的结果处理"></a>更好的结果处理</h1><p>在<code>route.api.js</code>中，我们利用 <code>res.json</code> 方法来响应请求并返回结果数据。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">res.json(&#123; success: false &#125;);</div><div class="line">res.json(&#123; success: true &#125;);</div><div class="line">res.json(&#123; success: true, postsList: posts &#125;);</div></pre></td></tr></table></figure>
<p>在处理结果时，我们将错误分为两类。</p>
<ol>
<li>webapp不提供的能力。</li>
<li>webapp自身的逻辑错误。</li>
</ol>
<h2 id="webapp不提供的能力"><a href="#webapp不提供的能力" class="headerlink" title="webapp不提供的能力"></a>webapp不提供的能力</h2><p>webapp提供的页面和数据能力是有限的。当客户端发起了一个不存在的路由访问，势必拿不到页面或者数据。</p>
<p>在前面的小节中，我们知道在 app.js中有统一的错误处理。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// catch 404 and forward to error handler</span></div><div class="line">app.use(<span class="function"><span class="keyword">function</span>(<span class="params">req, res, next</span>) </span>&#123;</div><div class="line">  <span class="keyword">var</span> err = <span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">'Not Found'</span>);</div><div class="line">  err.status = <span class="number">404</span>;</div><div class="line">  next(err);</div><div class="line">&#125;);</div><div class="line"></div><div class="line"><span class="comment">// error handler</span></div><div class="line">app.use(<span class="function"><span class="keyword">function</span>(<span class="params">err, req, res, next</span>) </span>&#123;</div><div class="line">  <span class="comment">// set locals, only providing error in development</span></div><div class="line">  res.locals.message = err.message;</div><div class="line">  res.locals.error = req.app.get(<span class="string">'env'</span>) === <span class="string">'development'</span> ? err : &#123;&#125;;</div><div class="line"></div><div class="line">  <span class="comment">// render the error page</span></div><div class="line">  res.status(err.status || <span class="number">500</span>);</div><div class="line">  res.render(<span class="string">'error'</span>);</div><div class="line">&#125;);</div></pre></td></tr></table></figure>
<h2 id="修改数据返回的错误"><a href="#修改数据返回的错误" class="headerlink" title="修改数据返回的错误"></a>修改数据返回的错误</h2><p>靠 {success: false} 或者 { success: true} 来区分是否存在错误逻辑似乎不是特别的好。</p>
<p>我们可以借助这个统一的错误中枢来统一处理所有的错误。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/* GET posts lists */</span></div><div class="line">router.get(<span class="string">'/posts'</span>, <span class="function"><span class="keyword">function</span>(<span class="params">req, res, next</span>) </span>&#123;</div><div class="line">  PostModel.find(&#123;&#125;, &#123;&#125;, <span class="function"><span class="keyword">function</span>(<span class="params">err, posts</span>) </span>&#123;</div><div class="line">    <span class="keyword">if</span> (err) &#123;</div><div class="line">      res.json(&#123; <span class="attr">success</span>: <span class="literal">false</span> &#125;);</div><div class="line">    &#125; <span class="keyword">else</span> &#123;</div><div class="line">      res.json(&#123; <span class="attr">success</span>: <span class="literal">true</span>, <span class="attr">postsList</span>: posts &#125;);</div><div class="line">    &#125;</div><div class="line">  &#125;);</div><div class="line">&#125;);</div></pre></td></tr></table></figure>
<p>修改成</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/* GET posts lists */</span></div><div class="line">router.get(<span class="string">'/posts'</span>, <span class="function"><span class="keyword">function</span>(<span class="params">req, res, next</span>) </span>&#123;</div><div class="line">  PostModel.find(&#123;&#125;, &#123;&#125;, <span class="function"><span class="keyword">function</span>(<span class="params">err, posts</span>) </span>&#123;</div><div class="line">    <span class="keyword">if</span> (err) &#123;</div><div class="line">      err.status = <span class="number">500</span>;</div><div class="line">      next(err);</div><div class="line">    &#125; <span class="keyword">else</span> &#123;</div><div class="line">      res.json(&#123; <span class="attr">postsList</span>: posts &#125;);</div><div class="line">    &#125;</div><div class="line">  &#125;);</div><div class="line">&#125;);</div></pre></td></tr></table></figure>
<p>我们在err对象中加入status = 500，并把错误送给错误中枢统一返回给用户。</p>
<p>其他路由修改参考上面的样子。</p>
<p>似乎每个错误都有下面相面的代码。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">if</span> (err) &#123;</div><div class="line">  err.status = <span class="number">500</span>;</div><div class="line">  next(err);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>为了更好的管理错误处理，我们可以把错误抽离出来，以供不同的路由逻辑来调用。</p>
<p>新建 common/errorHandle.js 文件</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> errorHandle = <span class="function"><span class="keyword">function</span> (<span class="params">err, next</span>) </span>&#123;</div><div class="line">  err.status = <span class="number">500</span>;</div><div class="line">  next(err);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="built_in">module</span>.exports = errorHandle;</div></pre></td></tr></table></figure>
<p>然后在 route.api.js中引用该文件</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> errorHandle = <span class="built_in">require</span>(<span class="string">'./common/errorHandle'</span>);</div><div class="line"></div><div class="line"><span class="comment">/* GET posts lists */</span></div><div class="line">router.get(<span class="string">'/posts'</span>, <span class="function"><span class="keyword">function</span>(<span class="params">req, res, next</span>) </span>&#123;</div><div class="line">  PostModel.find(&#123;&#125;, &#123;&#125;, <span class="function"><span class="keyword">function</span>(<span class="params">err, posts</span>) </span>&#123;</div><div class="line">    <span class="keyword">if</span> (err) &#123;</div><div class="line">      errorHandle(err, next);</div><div class="line">    &#125; <span class="keyword">else</span> &#123;</div><div class="line">      res.json(&#123; <span class="attr">postsList</span>: posts &#125;);</div><div class="line">    &#125;</div><div class="line">  &#125;);</div><div class="line">&#125;);</div></pre></td></tr></table></figure>
<h2 id="修改客户端（接受结果）的处理"><a href="#修改客户端（接受结果）的处理" class="headerlink" title="修改客户端（接受结果）的处理"></a>修改客户端（接受结果）的处理</h2><p>在此前，posts.ejs中获取数据是如下处理</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">fetchData () &#123;</div><div class="line">  axios.get(<span class="string">'/api/v1/posts'</span>)</div><div class="line">    .then(<span class="function"><span class="keyword">function</span>(<span class="params">response</span>) </span>&#123;</div><div class="line">      vm.postsList = response.data.postsList;</div><div class="line">      vm.postsList.forEach(<span class="function">(<span class="params">element</span>) =&gt;</span> element.url = <span class="string">'/posts/show?id='</span> + element._id);</div><div class="line">    &#125;)</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>这个处理并没有进行错误检查。上面我们知道，当服务端出现错误会返回状态码500。因此我们要接住这个错误才能保证逻辑正确处理。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line">fetchData () &#123;</div><div class="line">  axios.get(<span class="string">'/api/v1/posts'</span>)</div><div class="line">    .then(<span class="function"><span class="keyword">function</span>(<span class="params">response</span>) </span>&#123;</div><div class="line">      <span class="keyword">if</span> (response.status !== <span class="number">200</span>) &#123;</div><div class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">'error!'</span>);</div><div class="line">      &#125;</div><div class="line"></div><div class="line">      <span class="keyword">return</span> response.data;</div><div class="line">    &#125;)</div><div class="line">    .then(<span class="function"><span class="keyword">function</span>(<span class="params">data</span>) </span>&#123;</div><div class="line">      vm.postsList = data.postsList;</div><div class="line">      vm.postsList.forEach(<span class="function">(<span class="params">element</span>) =&gt;</span> element.url = <span class="string">'/posts/show?id='</span> + element._id);</div><div class="line">    &#125;)</div><div class="line">    .catch(<span class="function"><span class="keyword">function</span>(<span class="params">err</span>) </span>&#123;</div><div class="line">      alert(err);</div><div class="line">    &#125;)</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>第一个<code>then</code>函数会处理status不为200的场合并抛出一个异常（只要状态不是200就全认为是处理错误）。</li>
<li>如果状态是200，就把reponse中的data给第二个<code>then</code>函数。</li>
<li><code>then</code>函数是promise用法中的重要环节，简明说明请参考<a href="http://code.7xinsheng.com/post/59d3b0dbfbbefc4e650f4c0d" target="_blank" rel="external">点这里</a></li>
</ul>
<p>在views文件夹其他页面中获取数据的处理请参考上面的案例修改。</p>
<h2 id="总结-1"><a href="#总结-1" class="headerlink" title="总结"></a>总结</h2><ol>
<li>尽量通过统一的错误处理逻辑。</li>
<li>尽量使用状态码，而不是自己设计一个错误值。例如：success：false/true。</li>
<li>客户端页面要对错误进行错误处理以保证健壮性。</li>
</ol>
<h2 id="特别提醒"><a href="#特别提醒" class="headerlink" title="特别提醒"></a>特别提醒</h2><p>在 <code>route.api.js</code>中创建post的路由处理中，可以把写入到数据库的数据重新返回给客户端。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/* POST create post */</span></div><div class="line">router.post(<span class="string">'/posts'</span>, <span class="function"><span class="keyword">function</span>(<span class="params">req, res, next</span>) </span>&#123;</div><div class="line">  <span class="keyword">var</span> title = req.body.title;</div><div class="line">  <span class="keyword">var</span> content = req.body.content;</div><div class="line"></div><div class="line">  <span class="keyword">var</span> post = <span class="keyword">new</span> PostModel();</div><div class="line">  post.title = title;</div><div class="line">  post.content = content;</div><div class="line">  post.save(<span class="function"><span class="keyword">function</span>(<span class="params">err, doc</span>) </span>&#123;</div><div class="line">    <span class="keyword">if</span> (err) &#123;</div><div class="line">      errorHandle(err, next);</div><div class="line">    &#125; <span class="keyword">else</span> &#123;</div><div class="line">      res.json(&#123;<span class="attr">post</span>: doc&#125;); <span class="comment">// 注意这里</span></div><div class="line">    &#125;</div><div class="line">  &#125;);</div><div class="line">&#125;);</div></pre></td></tr></table></figure>
<p>一般情况下，新创建的数据需要返回给客户端一份，为什么呢？因为写入到数据库后会给这条数据产生一个唯一的id，而客户端拿到这个id可以进行一些交互操作。</p>
<p>比如，在 <code>.views/create.js</code>中</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line">submit () &#123;</div><div class="line">  axios.post(<span class="string">'/api/v1/posts'</span>,</div><div class="line">    &#123;</div><div class="line">      title: vm.title,</div><div class="line">      content: vm.content</div><div class="line">    &#125;)</div><div class="line">    .then(<span class="function"><span class="keyword">function</span>(<span class="params">response</span>) </span>&#123;</div><div class="line">      <span class="keyword">if</span> (response.status !== <span class="number">200</span>) &#123;</div><div class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">'error!'</span>);</div><div class="line">      &#125;</div><div class="line"></div><div class="line">      <span class="keyword">return</span> response.data;</div><div class="line">    &#125;)</div><div class="line">    .then(<span class="function"><span class="keyword">function</span>(<span class="params">data</span>) </span>&#123;</div><div class="line">      <span class="comment">// 注意这句</span></div><div class="line">      <span class="built_in">window</span>.location = <span class="string">'/posts/show?id='</span> + data.post._id;</div><div class="line">    &#125;)</div><div class="line">    .catch(<span class="function"><span class="keyword">function</span>(<span class="params">err</span>) </span>&#123;</div><div class="line">      alert(err);</div><div class="line">    &#125;)</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>可以通过服务端返回的post数据来打开刚刚创建的文章页面。</p>
<p>编辑文章时，服务端不需要返回完整的数据。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/* PATCH edit post */</span></div><div class="line">router.patch(<span class="string">'/posts/:id'</span>, <span class="function"><span class="keyword">function</span>(<span class="params">req, res, next</span>) </span>&#123;</div><div class="line">  <span class="keyword">var</span> id = req.params.id;</div><div class="line">  <span class="keyword">var</span> title = req.body.title;</div><div class="line">  <span class="keyword">var</span> content = req.body.content;</div><div class="line"></div><div class="line">  PostModel.findOneAndUpdate(&#123; <span class="attr">_id</span>: id &#125;, &#123; title, content &#125;, <span class="function"><span class="keyword">function</span>(<span class="params">err</span>) </span>&#123;</div><div class="line">    <span class="keyword">if</span> (err) &#123;</div><div class="line">      errorHandle(err, next);</div><div class="line">    &#125; <span class="keyword">else</span> &#123;</div><div class="line">      res.json(&#123;&#125;); <span class="comment">// 不需要返回文章数据</span></div><div class="line">    &#125;</div><div class="line">  &#125;);</div><div class="line">&#125;);</div></pre></td></tr></table></figure>
<p>因为编辑是对一个已经在数据库中的数据进行编辑，客户端自身有这条数据的id。 所以，在 <code>./views/edit.ejs</code>中，只需要用本地已经有的id来进行页面跳转。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line">submit () &#123;</div><div class="line">  axios.patch(<span class="string">'/api/v1/posts/'</span> + postId,</div><div class="line">    &#123;</div><div class="line">      title: vm.title,</div><div class="line">      content: vm.content</div><div class="line">    &#125;)</div><div class="line">    .then(<span class="function"><span class="keyword">function</span>(<span class="params">response</span>) </span>&#123;</div><div class="line">      <span class="keyword">if</span> (response.status !== <span class="number">200</span>) &#123;</div><div class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">'error!'</span>);</div><div class="line">      &#125;</div><div class="line"></div><div class="line">      <span class="keyword">return</span> response.data;</div><div class="line">    &#125;)</div><div class="line">    .then(<span class="function"><span class="keyword">function</span>(<span class="params">data</span>) </span>&#123;</div><div class="line">      <span class="comment">// 注意这里，用的是既有的postId来跳转到文章页面</span></div><div class="line">      <span class="built_in">window</span>.location = <span class="string">'/posts/show?id='</span> + postId</div><div class="line">    &#125;)</div><div class="line">    .catch(<span class="function"><span class="keyword">function</span>(<span class="params">err</span>) </span>&#123;</div><div class="line">      alert(err);</div><div class="line">    &#125;)</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>这也说明了http的post和patch的使用区别，post可能需要服务端返回数据，patch不需要服务端返回数据。</p>
<p>参考事例 <a href="https://github.com/xugy0926/learn-webapp-sample/tree/master/first-app-sample-15" target="_blank" rel="external">first-app-sample-15</a></p>
<h1 id="停下来想一想"><a href="#停下来想一想" class="headerlink" title="停下来想一想"></a>停下来想一想</h1><p>通过22个小节，我们做出了一个简单的内容发布WebApp。在通过进一步之前，我建议你停下来并认真复习和思考一下。</p>
<ol>
<li>开发一个WebApp为什么需要Express，Express能带给你什么好处？</li>
<li>WebApp中的package.json在整个工程起到了什么作用？</li>
<li>在Express中Router的价值。</li>
<li>为什么要对router进行分类管理，分成route.api.js和route.page.js的好处是什么？</li>
<li>在整个数据流中，为什么要传递req和res这两个对象。</li>
<li>视图引擎是否可以定位到任意路径的文件夹。</li>
<li>app.js中的两个错误处理函数的（错误中枢）的工作原理，理解逻辑处理中的错误处理统一到错误中枢的价值。</li>
<li>ejs中 &lt;%- %&gt; 和 &lt;%= %&gt; 的差异是什么？</li>
<li>mongodb中的scheme是什么意思？</li>
</ol>
<h1 id="添加导航条"><a href="#添加导航条" class="headerlink" title="添加导航条"></a>添加导航条</h1><p>导航条是一个页面最重要的模块，bootstrap3.0 提供了很方便的导航条解决方案。</p>
<p><a href="http://v3.bootcss.com/components/#navbar" target="_blank" rel="external">http://v3.bootcss.com/components/#navbar</a></p>
<p>首先在views里新建一个_nav.ejs</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">nav</span> <span class="attr">class</span>=<span class="string">"navbar navbar-default"</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"container-fluid"</span>&gt;</span></div><div class="line">    <span class="comment">&lt;!-- Brand and toggle get grouped for better mobile display --&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"navbar-header"</span>&gt;</span></div><div class="line">      <span class="tag">&lt;<span class="name">button</span> <span class="attr">type</span>=<span class="string">"button"</span> <span class="attr">class</span>=<span class="string">"navbar-toggle collapsed"</span> <span class="attr">data-toggle</span>=<span class="string">"collapse"</span> <span class="attr">data-target</span>=<span class="string">"#bs-example-navbar-collapse-1"</span> <span class="attr">aria-expanded</span>=<span class="string">"false"</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">span</span> <span class="attr">class</span>=<span class="string">"sr-only"</span>&gt;</span>Toggle navigation<span class="tag">&lt;/<span class="name">span</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">span</span> <span class="attr">class</span>=<span class="string">"icon-bar"</span>&gt;</span><span class="tag">&lt;/<span class="name">span</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">span</span> <span class="attr">class</span>=<span class="string">"icon-bar"</span>&gt;</span><span class="tag">&lt;/<span class="name">span</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">span</span> <span class="attr">class</span>=<span class="string">"icon-bar"</span>&gt;</span><span class="tag">&lt;/<span class="name">span</span>&gt;</span></div><div class="line">      <span class="tag">&lt;/<span class="name">button</span>&gt;</span></div><div class="line">      <span class="tag">&lt;<span class="name">a</span> <span class="attr">class</span>=<span class="string">"navbar-brand"</span> <span class="attr">href</span>=<span class="string">"/"</span>&gt;</span>我的世界<span class="tag">&lt;/<span class="name">a</span>&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></div><div class="line"></div><div class="line">    <span class="comment">&lt;!-- Collect the nav links, forms, and other content for toggling --&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"collapse navbar-collapse"</span> <span class="attr">id</span>=<span class="string">"bs-example-navbar-collapse-1"</span>&gt;</span></div><div class="line">      <span class="tag">&lt;<span class="name">ul</span> <span class="attr">class</span>=<span class="string">"nav navbar-nav"</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">li</span>&gt;</span><span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">"/posts"</span>&gt;</span>文章<span class="tag">&lt;/<span class="name">a</span>&gt;</span><span class="tag">&lt;/<span class="name">li</span>&gt;</span></div><div class="line">      <span class="tag">&lt;/<span class="name">ul</span>&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></div><div class="line">  <span class="tag">&lt;/<span class="name">div</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">nav</span>&gt;</span></div></pre></td></tr></table></figure>
<p>然后在<code>views/layout.ejs</code> 中加入对 _nav.ejs 的引入</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"container"</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">%</span> <span class="attr">include</span> <span class="attr">.</span>/<span class="attr">_nav</span> %&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">%-</span> <span class="attr">body</span> %&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></div></pre></td></tr></table></figure>
<p>这里有3个注意点：</p>
<ol>
<li>将导航条的html放入在 _nav.ejs 是为了更好的页面模块分类。</li>
<li>命名用下划线_ 开始，我是想强调这个ejs是供其他页面引用，而不是一个独立页面，这样可以将内部模块（组件）和独立页面分开。</li>
<li>在页面中引入其他的模块用 <code>&lt;% include file_path %&gt;</code>，include关键字和c语言中引入库的关键字一样。</li>
</ol>
<p>参考 <a href="https://github.com/xugy0926/learn-webapp-sample/tree/master/first-app-sample-16" target="_blank" rel="external">first-app-sample-16</a></p>
<h1 id="添加账号系统"><a href="#添加账号系统" class="headerlink" title="添加账号系统"></a>添加账号系统</h1><p>在 webapp 中，账号信息可以记录在浏览器里的 cookie 模块，浏览器会根据不同的域名来分配一块 cookie 空间。</p>
<p>当用户在页面输入账号和密码后，webapp 验证登录信息是正确的，这时服务会把账户信息塞到请求的 cookie 中并返回给客户端，客户端拿到信息后，把账户信息存在浏览器的 cookie 中。</p>
<p>下一次客户端向服务发起请求时，浏览器会帮我们自动把 cookie 附加到请求里，以供服务来判断这是一个已经登录的用户。当服务收到请求后，第一件事情应该是分析 cookie 里的信息并判断这个用户是不是一个真实的用户。</p>
<h2 id="一次登录过程"><a href="#一次登录过程" class="headerlink" title="一次登录过程"></a>一次登录过程</h2><p><a href="https://github.com/xugy0926/learn-webapp-guideline/blob/master/assets/login.png" target="_blank" rel="external"><img src="https://github.com/xugy0926/learn-webapp-guideline/raw/master/assets/login.png" alt="img"></a></p>
<p>在登录时，服务判断账户和密码准确后，会把相关用户信息放在� response 里 cookie 体内。</p>
<p>当服务响应登录请求后，客户端会收到 response 里的 cookie 信息并存在浏览器的 cookie 模块里。</p>
<h2 id="一次请求过程"><a href="#一次请求过程" class="headerlink" title="一次请求过程"></a>一次请求过程</h2><p><a href="https://github.com/xugy0926/learn-webapp-guideline/blob/master/assets/request-cookie.png" target="_blank" rel="external"><img src="https://github.com/xugy0926/learn-webapp-guideline/raw/master/assets/request-cookie.png" alt="img"></a></p>
<p>每次往服务发 http 请求时，浏览器里的 cookie 都会被默认带上，服务器收到请求第一件事就是分析 cookie 信息并判断该用户是否存在，如果存在就认为该用户是登录的。</p>
<p>虽然 cookie 最终存在浏览器里，但 cookie 信息不能人为串改的。写入到浏览器的 cookie 信息和分析 cookie 都是由服务来进行。</p>
<h2 id="添加存储用户信息的表"><a href="#添加存储用户信息的表" class="headerlink" title="添加存储用户信息的表"></a>添加存储用户信息的表</h2><p>新建用户信息表</p>
<p>// filepath: models/user.js</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">var mongoose = require(&apos;mongoose&apos;);</div><div class="line">var Schema = mongoose.Schema;</div><div class="line"></div><div class="line">var UserSchema = new Schema(&#123;</div><div class="line">    name: String,</div><div class="line">    pass: String</div><div class="line">&#125;);</div><div class="line"></div><div class="line">const UserModel = mongoose.model(&apos;User&apos;, UserSchema);</div><div class="line"></div><div class="line">module.exports = UserModel;</div></pre></td></tr></table></figure>
<p>上面只存了两个字段：名字和密码。</p>
<h2 id="定义一个全局的配置文件"><a href="#定义一个全局的配置文件" class="headerlink" title="定义一个全局的配置文件"></a>定义一个全局的配置文件</h2><p>新建配置文件。</p>
<p>// filepath: config.js</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">module.exports = &#123;</div><div class="line">  cookieName: &apos;your_cookie_name&apos;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>存在 cookie 里的信息一定需要一个名字。</p>
<p>为了更好的管理，设计一个 config.js 来管理 webapp 中更多的静态信息。比如：后面可以把数据库的 url 在这里定义。</p>
<h2 id="增加登录和注册页面"><a href="#增加登录和注册页面" class="headerlink" title="增加登录和注册页面"></a>增加登录和注册页面</h2><h3 id="添加新的页面路由处理"><a href="#添加新的页面路由处理" class="headerlink" title="添加新的页面路由处理"></a>添加新的页面路由处理</h3><p>// filepath: route.page.js</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">/* GET signup page. */</div><div class="line">router.get(&apos;/signup&apos;, function(req, res, next) &#123;</div><div class="line">  res.render(&apos;signup&apos;);</div><div class="line">&#125;);</div><div class="line"></div><div class="line">/* GET signin page. */</div><div class="line">router.get(&apos;/signin&apos;, function (req, res, next) &#123;</div><div class="line">  res.render(&apos;signin&apos;);</div><div class="line">&#125;);</div></pre></td></tr></table></figure>
<h3 id="新建登录页面"><a href="#新建登录页面" class="headerlink" title="新建登录页面"></a>新建登录页面</h3><p>// filepath: views/signin.ejs</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div></pre></td><td class="code"><pre><div class="line">&lt;div class=&quot;col-md-4 col-md-offset-4&quot;&gt;</div><div class="line">  &lt;h1&gt;登录&lt;/h1&gt;</div><div class="line">  &lt;div class=&quot;form-group&quot;&gt;</div><div class="line">    &lt;input type=&quot;text&quot; class=&quot;form-control&quot; v-model=&quot;name&quot; placeholder=&quot;账号&quot;&gt;</div><div class="line">  &lt;/div&gt;</div><div class="line">  &lt;div class=&quot;form-group&quot;&gt;</div><div class="line">    &lt;input type=&quot;password&quot; class=&quot;form-control&quot; v-model=&quot;pass&quot; placeholder=&quot;密码&quot;&gt;</div><div class="line">  &lt;/div&gt;</div><div class="line">  &lt;div class=&quot;form-group&quot;&gt;</div><div class="line">    &lt;button class=&quot;btn btn-default&quot; v-on:click=&quot;submit&quot;&gt;提交&lt;/button&gt;</div><div class="line">  &lt;/div&gt;</div><div class="line">&lt;/div&gt;</div><div class="line">&lt;script&gt;</div><div class="line"></div><div class="line">var vm = new Vue(&#123;</div><div class="line">  el: &apos;#app&apos;,</div><div class="line">  data: &#123;</div><div class="line">    name: &apos;&apos;,</div><div class="line">    pass: &apos;&apos;</div><div class="line">  &#125;,</div><div class="line">  methods: &#123;</div><div class="line">    submit () &#123;</div><div class="line">      axios.post(&apos;/api/v1/signin&apos;,</div><div class="line">        &#123;</div><div class="line">          name: vm.name,</div><div class="line">          pass: vm.pass</div><div class="line">        &#125;)</div><div class="line">        .then(function(response) &#123;</div><div class="line">          if (response.status !== 200) &#123;</div><div class="line">            throw new Error(&apos;error!&apos;);</div><div class="line">          &#125;</div><div class="line"></div><div class="line">          return response.data;</div><div class="line">        &#125;)</div><div class="line">        .then(function(data) &#123;</div><div class="line">          window.location = &apos;/&apos;;</div><div class="line">        &#125;)</div><div class="line">        .catch(function(err) &#123;</div><div class="line">          alert(err);</div><div class="line">        &#125;)</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line">&#125;);</div><div class="line">&lt;/script&gt;</div></pre></td></tr></table></figure>
<h3 id="新建注册页面"><a href="#新建注册页面" class="headerlink" title="新建注册页面"></a>新建注册页面</h3><p>注册页面会比登录页面多一个重复密码的输入，这是为了保证用户在输入新密码时不出错。</p>
<p>// filepath: views/signup.ejs</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div></pre></td><td class="code"><pre><div class="line">&lt;div class=&quot;col-md-4 col-md-offset-4&quot;&gt;</div><div class="line">  &lt;h1&gt;登录&lt;/h1&gt;</div><div class="line">  &lt;div class=&quot;form-group&quot;&gt;</div><div class="line">    &lt;input type=&quot;text&quot; class=&quot;form-control&quot; v-model=&quot;name&quot; placeholder=&quot;账号&quot;&gt;</div><div class="line">  &lt;/div&gt;</div><div class="line">  &lt;div class=&quot;form-group&quot;&gt;</div><div class="line">    &lt;input type=&quot;password&quot; class=&quot;form-control&quot; v-model=&quot;pass&quot; placeholder=&quot;密码&quot;&gt;</div><div class="line">  &lt;/div&gt;</div><div class="line">  &lt;div class=&quot;form-group&quot;&gt;</div><div class="line">    &lt;input type=&quot;password&quot; class=&quot;form-control&quot; v-model=&quot;rePass&quot; placeholder=&quot;密码&quot;&gt;</div><div class="line">  &lt;/div&gt;</div><div class="line">  &lt;div class=&quot;form-group&quot;&gt;</div><div class="line">    &lt;button class=&quot;btn btn-default&quot; v-on:click=&quot;submit&quot;&gt;提交&lt;/button&gt;</div><div class="line">  &lt;/div&gt;</div><div class="line">&lt;/div&gt;</div><div class="line">&lt;script&gt;</div><div class="line"></div><div class="line">var vm = new Vue(&#123;</div><div class="line">  el: &apos;#app&apos;,</div><div class="line">  data: &#123;</div><div class="line">    name: &apos;&apos;,</div><div class="line">    pass: &apos;&apos;,</div><div class="line">    rePass: &apos;&apos;</div><div class="line">  &#125;,</div><div class="line">  methods: &#123;</div><div class="line">    submit () &#123;</div><div class="line">      axios.post(&apos;/api/v1/signup&apos;,</div><div class="line">        &#123;</div><div class="line">          name: vm.name,</div><div class="line">          pass: vm.pass,</div><div class="line">          rePass: vm.rePass</div><div class="line">        &#125;)</div><div class="line">        .then(function(response) &#123;</div><div class="line">          if (response.status !== 200) &#123;</div><div class="line">            throw new Error(&apos;error!&apos;);</div><div class="line">          &#125;</div><div class="line"></div><div class="line">          return response.data;</div><div class="line">        &#125;)</div><div class="line">        .then(function(data) &#123;</div><div class="line">          window.location = &apos;/&apos;;</div><div class="line">        &#125;)</div><div class="line">        .catch(function(err) &#123;</div><div class="line">          alert(err);</div><div class="line">        &#125;)</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line">&#125;);</div><div class="line">&lt;/script&gt;</div></pre></td></tr></table></figure>
<h2 id="添加登录和注册的http请求处理"><a href="#添加登录和注册的http请求处理" class="headerlink" title="添加登录和注册的http请求处理"></a>添加登录和注册的http请求处理</h2><h3 id="引入模块"><a href="#引入模块" class="headerlink" title="引入模块"></a>引入模块</h3><p>// filepath: route.api.js</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">var bcrypt = require(&apos;bcrypt&apos;);</div><div class="line">var UserModel = require(&apos;./models/user&apos;);</div><div class="line">var config = require(&apos;./config&apos;);</div></pre></td></tr></table></figure>
<p>一般存在数据库里的密码不能是明文的，bcrypt 这个库用来对密码做hash求值，将密码的hash值存在数据库中。</p>
<h3 id="处理-api-v1-signup-请求"><a href="#处理-api-v1-signup-请求" class="headerlink" title="处理 api/v1/signup 请求"></a>处理 api/v1/signup 请求</h3><p>// filepath: route.api.js</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line">/* POST signup user */</div><div class="line">router.post(&apos;/signup&apos;, function(req, res, next) &#123;</div><div class="line">  var name = req.body.name;</div><div class="line">  var pass = req.body.pass;</div><div class="line">  var rePass = req.body.rePass;</div><div class="line"></div><div class="line">  if (pass !== rePass) &#123;</div><div class="line">    return errorHandle(new Error(&apos;两次密码不对&apos;), next);</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  var user = new UserModel();</div><div class="line">  user.name = name;</div><div class="line">  user.pass = bcrypt.hashSync(pass, 10);</div><div class="line">  user.save(function(err) &#123;</div><div class="line">    if (err) &#123;</div><div class="line">      errorHandle(err, next);</div><div class="line">    &#125; else &#123;</div><div class="line">      res.end();</div><div class="line">    &#125;</div><div class="line">  &#125;);</div><div class="line">&#125;);</div></pre></td></tr></table></figure>
<p>处理注册请求时，要先对传入的两次密码进行对比，如果不一致就返回错误的响应。</p>
<p>在把注册信息保存到数据时，要将密码进行hash求值，数据库一定不能存密码明文。这不仅为了安全考虑，也是对用户的一个尊重。</p>
<h3 id="处理-api-v1-signin-请求"><a href="#处理-api-v1-signin-请求" class="headerlink" title="处理 api/v1/signin 请求"></a>处理 api/v1/signin 请求</h3><p>// filepath: route.api.js</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div></pre></td><td class="code"><pre><div class="line">/* POST signin user */</div><div class="line">router.post(&apos;/signin&apos;, function(req, res, next) &#123;</div><div class="line">  var name = req.body.name || &apos;&apos;;</div><div class="line">  var pass = req.body.pass || &apos;&apos;;</div><div class="line"></div><div class="line">  UserModel.findOne(&#123; name &#125;, function(err, user) &#123;</div><div class="line">    if (err || !user) &#123;</div><div class="line">      return errorHandle(new Error(&apos;找不到用户&apos;), next);</div><div class="line">    &#125; else &#123;</div><div class="line">      var isOk = bcrypt.compareSync(pass, user.pass);</div><div class="line">      if (!isOk) &#123;</div><div class="line">        return errorHandle(new Error(&apos;密码不对&apos;), next);</div><div class="line">      &#125;</div><div class="line"></div><div class="line">      var authToken = user._id;</div><div class="line">      var opts = &#123;</div><div class="line">        path: &apos;/&apos;,</div><div class="line">        maxAge: 1000 * 60 * 60 * 24 * 30, // cookie 有效期30天</div><div class="line">        signed: true,</div><div class="line">        httpOnly: true</div><div class="line">      &#125;;</div><div class="line"></div><div class="line">      res.cookie(config.cookieName, authToken, opts);</div><div class="line">      res.end();</div><div class="line">    &#125;</div><div class="line">  &#125;);</div><div class="line">&#125;);</div><div class="line"></div><div class="line">module.exports = router;</div></pre></td></tr></table></figure>
<p>验证登录信息，要把用户输入的账号和密码与数据库里的账号和密码进行比较，如果一致，表明是一个已经注册过的用户。</p>
<p>上面把 user._id 当做 token 存在了 res.cookie 里。这里的核心是 res.cookie() 这个函数，它可以往 reponse 响应体内存入 cookie 信息以便浏览器能获得里面的信息。</p>
<p>opts 这个对象里记录了一些 cookie 的配置信息，这里最重要的是 maxAge 这个属性，它告诉浏览器，这个 cookie 只能有效多长时间。</p>
<h2 id="判断每一个http请求的cookie信息"><a href="#判断每一个http请求的cookie信息" class="headerlink" title="判断每一个http请求的cookie信息"></a>判断每一个http请求的cookie信息</h2><p>每一次 http 请求，服务都需要判断 cookie 中的信息，以确保当前发起请求的用户是否是登录状态。</p>
<h3 id="新建一个检查登录状态的中间件"><a href="#新建一个检查登录状态的中间件" class="headerlink" title="新建一个检查登录状态的中间件"></a>新建一个检查登录状态的中间件</h3><p>// filepath: ./middlewares/auth.js</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line">var config = require(&apos;../config&apos;);</div><div class="line">var UserModel = require(&apos;../models/user&apos;);</div><div class="line"></div><div class="line">function authUser(req, res, next) &#123;</div><div class="line">  const authToken = req.signedCookies[config.cookieName] || &apos;&apos;;</div><div class="line">  res.locals.currentUser = null;</div><div class="line"></div><div class="line">  if (authToken) &#123;</div><div class="line">    UserModel.findOne(&#123; _id: authToken &#125;, function(err, user) &#123;</div><div class="line">      if (err) &#123;</div><div class="line">        next();</div><div class="line">      &#125; else &#123;</div><div class="line">        res.locals.currentUser = user;</div><div class="line">        next();</div><div class="line">      &#125;</div><div class="line">    &#125;);</div><div class="line">  &#125; else &#123;</div><div class="line">    next();</div><div class="line">  &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line">module.exports = &#123; authUser &#125;;</div></pre></td></tr></table></figure>
<p>authUser 函数会把每一个请求的 cookie 数据读出来，因为服务指导 cookie 里存了什么，所以，在这里把读出来的值直接取数据库查用户信息即可。</p>
<p>查到的用户信息存在 res.locals.currentUser中。为什么存在这里？为了在视图引擎在处理 ejs 时能读到登录的用户信息。</p>
<h3 id="植入验证用户信息的中间件"><a href="#植入验证用户信息的中间件" class="headerlink" title="植入验证用户信息的中间件"></a>植入验证用户信息的中间件</h3><p>// filepath: app.js</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">var auth = require(&apos;./middlewares/auth&apos;);</div><div class="line"></div><div class="line">app.use(auth.authUser);</div><div class="line">app.use(&apos;/&apos;, page);</div><div class="line">app.use(&apos;/api/v1&apos;, api);</div></pre></td></tr></table></figure>
<h2 id="根据用户信息弹性的构建导航条"><a href="#根据用户信息弹性的构建导航条" class="headerlink" title="根据用户信息弹性的构建导航条"></a>根据用户信息弹性的构建导航条</h2><p>前面我们获取到了登录用户的信息并存在了 res.locals.currentUser 中。</p>
<p>可以利用 currentUser 这个对象来弹性的构建导航条信息。</p>
<p>// filepath: ./views/_nav.ejs</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div></pre></td><td class="code"><pre><div class="line">&lt;nav class=&quot;navbar navbar-default&quot;&gt;</div><div class="line">  &lt;div class=&quot;container-fluid&quot;&gt;</div><div class="line">    &lt;!-- Brand and toggle get grouped for better mobile display --&gt;</div><div class="line">    &lt;div class=&quot;navbar-header&quot;&gt;</div><div class="line">      &lt;button type=&quot;button&quot; class=&quot;navbar-toggle collapsed&quot; data-toggle=&quot;collapse&quot; data-target=&quot;#bs-example-navbar-collapse-1&quot; aria-expanded=&quot;false&quot;&gt;</div><div class="line">        &lt;span class=&quot;sr-only&quot;&gt;Toggle navigation&lt;/span&gt;</div><div class="line">        &lt;span class=&quot;icon-bar&quot;&gt;&lt;/span&gt;</div><div class="line">        &lt;span class=&quot;icon-bar&quot;&gt;&lt;/span&gt;</div><div class="line">        &lt;span class=&quot;icon-bar&quot;&gt;&lt;/span&gt;</div><div class="line">      &lt;/button&gt;</div><div class="line">      &lt;a class=&quot;navbar-brand&quot; href=&quot;/&quot;&gt;我的世界&lt;/a&gt;</div><div class="line">    &lt;/div&gt;</div><div class="line"></div><div class="line">    &lt;!-- Collect the nav links, forms, and other content for toggling --&gt;</div><div class="line">    &lt;div class=&quot;collapse navbar-collapse&quot; id=&quot;bs-example-navbar-collapse-1&quot;&gt;</div><div class="line">      &lt;ul class=&quot;nav navbar-nav&quot;&gt;</div><div class="line">        &lt;li&gt;&lt;a href=&quot;/posts&quot;&gt;文章&lt;/a&gt;&lt;/li&gt;</div><div class="line">      &lt;/ul&gt;</div><div class="line">      &lt;ul class=&quot;nav navbar-nav navbar-right&quot;&gt;</div><div class="line">        &lt;% if(currentUser) &#123;%&gt;</div><div class="line">        &lt;li class=&quot;dropdown&quot;&gt;</div><div class="line">          &lt;a href=&quot;#&quot; class=&quot;dropdown-toggle&quot; data-toggle=&quot;dropdown&quot; role=&quot;button&quot; aria-haspopup=&quot;true&quot; aria-expanded=&quot;false&quot;&gt;&lt;%= currentUser.name %&gt; &lt;span class=&quot;caret&quot;&gt;&lt;/span&gt;&lt;/a&gt;</div><div class="line">          &lt;ul class=&quot;dropdown-menu&quot;&gt;</div><div class="line">            &lt;li&gt;&lt;a href=&quot;/signout&quot;&gt;退出&lt;/a&gt;&lt;/li&gt;</div><div class="line">          &lt;/ul&gt;</div><div class="line">        &lt;/li&gt;</div><div class="line">        &lt;% &#125; else &#123; %&gt;</div><div class="line">          &lt;li&gt;&lt;a href=&quot;/signin&quot;&gt;登录&lt;/a&gt;&lt;/li&gt;</div><div class="line">          &lt;li&gt;&lt;a href=&quot;/signup&quot;&gt;注册&lt;/a&gt;&lt;/li&gt;</div><div class="line">        &lt;% &#125; %&gt;</div><div class="line">      &lt;/ul&gt;</div><div class="line">    &lt;/div&gt;</div><div class="line">  &lt;/div&gt;</div><div class="line">&lt;/nav&gt;</div></pre></td></tr></table></figure>
<p>参考 <a href="https://github.com/xugy0926/learn-webapp-sample/tree/master/first-app-sample-17" target="_blank" rel="external">first-app-sample-17</a></p>
<h1 id="访问权限"><a href="#访问权限" class="headerlink" title="访问权限"></a>访问权限</h1><p>当有了账户功能后，可以用是否是登录状态来设置一些功能。</p>
<h2 id="给-post-添加作者-id"><a href="#给-post-添加作者-id" class="headerlink" title="给 post 添加作者 id"></a>给 post 添加作者 id</h2><p>数据库中只存储 post 的 title 和 content 两个字段，有了账户信息后，可以存储作者的 id。</p>
<p>// filepath: models/post.js</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line">var mongoose = require(&apos;mongoose&apos;);</div><div class="line">var Schema = mongoose.Schema;</div><div class="line"></div><div class="line">var ObjectId = Schema.ObjectId;</div><div class="line"></div><div class="line">var PostSchema = new Schema(&#123;</div><div class="line">    title: String,</div><div class="line">    content: String,</div><div class="line">    authorId: ObjectId, // 添加作者 ID。</div><div class="line">&#125;);</div><div class="line"></div><div class="line">const PostModel = mongoose.model(&apos;Post&apos;, PostSchema);</div><div class="line"></div><div class="line">module.exports = PostModel;</div></pre></td></tr></table></figure>
<p>在处理 post 请求时，将 res.locals.currentUser._id 的值存到 post 的 authorId ，这样就会把作者的 id 写入到数据库中。</p>
<p>// filepath: route.api.js</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line">/* POST create post */</div><div class="line">router.post(&apos;/posts&apos;, function (req, res, next) &#123;</div><div class="line">  var title = req.body.title;</div><div class="line">  var content = req.body.content;</div><div class="line">  </div><div class="line">  var post = new PostModel();</div><div class="line">  post.title = title;</div><div class="line">  post.content = content;</div><div class="line">  post.authorId = res.locals.currentUser._id;</div><div class="line">  post.save(function(err, doc) &#123;</div><div class="line">    if (err) &#123;</div><div class="line">      errorHandle(err, next);</div><div class="line">    &#125; else &#123;</div><div class="line">      res.json(&#123; post: doc &#125;);</div><div class="line">    &#125;</div><div class="line">  &#125;);</div><div class="line">&#125;);</div></pre></td></tr></table></figure>
<h2 id="限制新建-post-的处理"><a href="#限制新建-post-的处理" class="headerlink" title="限制新建 post 的处理"></a>限制新建 post 的处理</h2><p>在 views/posts.ejs 中有一个新建文章的菜单，这里应该限制登录的用户才能创建文章。</p>
<p>判断 currentUser 变量是否存在，如果存在说明用户是登录状态，才显示创建菜单</p>
<p>// filepath: views/posts.ejs</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">&lt;% if(currentUser) &#123; %&gt;</div><div class="line">&lt;!-- Split button --&gt;</div><div class="line">&lt;div class=&quot;btn-group pull-right&quot;&gt;</div><div class="line">  &lt;button type=&quot;button&quot; class=&quot;btn btn-default&quot;&gt;操作&lt;/button&gt;</div><div class="line">  &lt;button type=&quot;button&quot; class=&quot;btn btn-default dropdown-toggle&quot; data-toggle=&quot;dropdown&quot; aria-haspopup=&quot;true&quot; aria-expanded=&quot;false&quot;&gt;</div><div class="line">    &lt;span class=&quot;caret&quot;&gt;&lt;/span&gt;</div><div class="line">    &lt;span class=&quot;sr-only&quot;&gt;Toggle Dropdown&lt;/span&gt;</div><div class="line">  &lt;/button&gt;</div><div class="line">  &lt;ul class=&quot;dropdown-menu&quot;&gt;</div><div class="line">    &lt;li&gt;&lt;a href=&quot;/posts/create&quot;&gt;新建&lt;/a&gt;&lt;/li&gt;</div><div class="line">  &lt;/ul&gt;</div><div class="line">&lt;/div&gt;</div><div class="line">&lt;% &#125; %&gt;</div></pre></td></tr></table></figure>
<h2 id="显示编辑-post-的处理"><a href="#显示编辑-post-的处理" class="headerlink" title="显示编辑 post 的处理"></a>显示编辑 post 的处理</h2><p>一般情况下只能登录用户是文章作者才能编辑文章，所以要对编辑菜单进行判断。</p>
<p>判断 currentUser 存在并且 currentUser 的 id 值和 post 的作者一致才显示编辑菜单。</p>
<p>// filepath: views/show.ejs</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">&lt;% if(currentUser &amp;&amp; currentUser._id.toString() === post.authorId.toString() ) &#123; %&gt;</div><div class="line">&lt;!-- Split button --&gt;</div><div class="line">&lt;div class=&quot;btn-group pull-right&quot;&gt;</div><div class="line">  &lt;button type=&quot;button&quot; class=&quot;btn btn-default&quot;&gt;操作&lt;/button&gt;</div><div class="line">  &lt;button type=&quot;button&quot; class=&quot;btn btn-default dropdown-toggle&quot; data-toggle=&quot;dropdown&quot; aria-haspopup=&quot;true&quot; aria-expanded=&quot;false&quot;&gt;</div><div class="line">    &lt;span class=&quot;caret&quot;&gt;&lt;/span&gt;</div><div class="line">    &lt;span class=&quot;sr-only&quot;&gt;Toggle Dropdown&lt;/span&gt;</div><div class="line">  &lt;/button&gt;</div><div class="line">  &lt;ul class=&quot;dropdown-menu&quot;&gt;</div><div class="line">    &lt;li&gt;&lt;a href=&quot;/posts/edit?id=&lt;%= post._id %&gt;&quot;&gt;编辑&lt;/a&gt;&lt;/li&gt;</div><div class="line">  &lt;/ul&gt;</div><div class="line">&lt;/div&gt;</div><div class="line">&lt;% &#125; %&gt;</div></pre></td></tr></table></figure>
<h2 id="整理配置信息（改善）"><a href="#整理配置信息（改善）" class="headerlink" title="整理配置信息（改善）"></a>整理配置信息（改善）</h2><p>将链接 mongodb 的 url 写入到 config.js 中，这样可以更方便管理 webapp 的各种配置信息。</p>
<p>// filepath: config.js</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">module.exports = &#123;</div><div class="line">  cookieName: &apos;your_cookie_name&apos;,</div><div class="line">  mongodbUrl: &apos;mongodb://localhost:32768/firstapp&apos;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>链接数据时只需要使用 config 的 mongodbUrl 即可</p>
<p>// filepath: models/init.js</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">var mongoose = require(&apos;mongoose&apos;);</div><div class="line">var config = require(&apos;../config&apos;);</div><div class="line"></div><div class="line">mongoose.connect(config.mongodbUrl, &#123;</div><div class="line">  useMongoClient: true</div><div class="line">&#125;);</div></pre></td></tr></table></figure>
<p>参考 <a href="https://github.com/xugy0926/learn-webapp-sample/tree/master/first-app-sample-18" target="_blank" rel="external">first-app-sample-18</a></p>
<h1 id="Kitematic"><a href="#Kitematic" class="headerlink" title="Kitematic"></a>Kitematic</h1><p>Docker是一个应用容器引擎，开发者可以打包他们的应用及依赖包到一个可移植的容器中，也可以实现虚拟化，容器使用沙箱机制，因此不会污染电脑环境。</p>
<p>(<a href="https://baike.baidu.com/item/Docker/13344470?fr=aladdin" target="_blank" rel="external">https://baike.baidu.com/item/Docker/13344470?fr=aladdin),更准确的定义参见[docker官网](https://www.docker.com/#/production</a>,%E6%9B%B4%E5%87%86%E7%A1%AE%E7%9A%84%E5%AE%9A%E4%B9%89%E5%8F%82%E8%A7%81%5Bdocker%E5%AE%98%E7%BD%91%5D(<a href="https://www.docker.com/#/production" target="_blank" rel="external">https://www.docker.com/#/production</a>))</p>
<p>为了更方便的安装和使用Docker，推荐使用Kitematic客户端。</p>
<p>Kitematic 作用是方便你在Mac或Windows上使用Docker，是与Docker Toolbox捆绑在一起的传统解决方案</p>
<ul>
<li>可以自动安装设置Docker</li>
<li>提供直观的图形用户界面</li>
<li>Kitematic与Docker Machine集成 提供VirtualBox VM，在本地安装Docker引擎</li>
</ul>
<h2 id="下载Kitematic"><a href="#下载Kitematic" class="headerlink" title="下载Kitematic"></a>下载Kitematic</h2><p>进入官方<a href="https://www.docker.com/products/docker-toolbox" target="_blank" rel="external">下载链接</a>页面，根据您的系统，选择Mac或Windows版本的进行下载</p>
<p><a href="https://github.com/you7588/learn-webapp-guideline/blob/master/assets/install-mongodb-1.png" target="_blank" rel="external"><img src="https://github.com/you7588/learn-webapp-guideline/raw/master/assets/install-mongodb-1.png" alt="img"></a></p>
<p>因为下载比较慢，我存了一份mac版的放在了百度云，有需要的可以<a href="http://pan.baidu.com/s/1dFtms0L" target="_blank" rel="external">点击链接</a>下载 密码:<code>umxh</code></p>
<h2 id="安装-1"><a href="#安装-1" class="headerlink" title="安装"></a>安装</h2><p>下载完成打开一路继续就安装好了。</p>
<p><a href="https://github.com/you7588/learn-webapp-guideline/blob/master/assets/install-mongodb-2.png" target="_blank" rel="external"><img src="https://github.com/you7588/learn-webapp-guideline/raw/master/assets/install-mongodb-2.png" alt="img"></a></p>
<p>安装完毕有显示，左边图标表示 在终端快速启动Docker 右边图标表示 Kitematic Docker的管理工具</p>
<p>之后你可以在你的应用里找到这两个应用。</p>
<h2 id="安装mongodb-1"><a href="#安装mongodb-1" class="headerlink" title="安装mongodb"></a>安装mongodb</h2><p>在Kitematic界面搜索mongo</p>
<p><a href="https://github.com/you7588/learn-webapp-guideline/blob/master/assets/install-mongodb-4.png" target="_blank" rel="external"><img src="https://github.com/you7588/learn-webapp-guideline/raw/master/assets/install-mongodb-4.png" alt="img"></a></p>
<p>点击“create”按钮就可以下载并安装mongodb的镜像，完成后会自动启动mongodb。</p>
<p><a href="https://github.com/you7588/learn-webapp-guideline/blob/master/assets/install-mongodb-5.png" target="_blank" rel="external"><img src="https://github.com/you7588/learn-webapp-guideline/raw/master/assets/install-mongodb-5.png" alt="img"></a></p>
<p>右边出现的端口就是你在程序中要用的，每个人端口可能不一样。</p>
<h1 id="关于作者"><a href="#关于作者" class="headerlink" title="关于作者"></a>关于作者</h1><ul>
<li>name: xugaoyang</li>
<li>email: <a href="mailto:i@xugaoyang.com" target="_blank" rel="external">i@xugaoyang.com</a></li>
</ul>

      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/JS/" rel="tag"># JS</a>
          
        </div>
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2017/11/03/HTML/" rel="next" title="HTML">
                <i class="fa fa-chevron-left"></i> HTML
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          


          
  <div class="comments" id="comments">
    
      <div id="disqus_thread">
        <noscript>
          Please enable JavaScript to view the
          <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a>
        </noscript>
      </div>
    
  </div>


        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap" >
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview">
            站点概览
          </li>
        </ul>
      

      <section class="site-overview sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          
            <img class="site-author-image" itemprop="image"
              src="https://ws2.sinaimg.cn/large/006tKfTcly1fj5edaynjzj30hs0hsglv.jpg"
              alt="Katherine Chen" />
          
            <p class="site-author-name" itemprop="name">Katherine Chen</p>
            <p class="site-description motion-element" itemprop="description">尽量只写对别人有用的文章……</p>
        </div>

        <nav class="site-state motion-element">

          
            <div class="site-state-item site-state-posts">
            
              <a href="/archives/">
            
                <span class="site-state-item-count">23</span>
                <span class="site-state-item-name">日志</span>
              </a>
            </div>
          

          
            
            
            <div class="site-state-item site-state-categories">
              <a href="/categories/index.html">
                <span class="site-state-item-count">3</span>
                <span class="site-state-item-name">分类</span>
              </a>
            </div>
          

          
            
            
            <div class="site-state-item site-state-tags">
              <a href="/about/index.html">
                <span class="site-state-item-count">15</span>
                <span class="site-state-item-name">标签</span>
              </a>
            </div>
          

        </nav>

        

        <div class="links-of-author motion-element">
          
            
              <span class="links-of-author-item">
                <a href="https://github.com/you7588" target="_blank" title="GitHub">
                  
                    <i class="fa fa-fw fa-github"></i>
                  
                    
                      GitHub
                    
                </a>
              </span>
            
              <span class="links-of-author-item">
                <a href="mailto:you7588@gmail.com" target="_blank" title="E-Mail">
                  
                    <i class="fa fa-fw fa-envelope"></i>
                  
                    
                      E-Mail
                    
                </a>
              </span>
            
          
        </div>

        
        

        
        

        


      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#介绍"><span class="nav-number">1.</span> <span class="nav-text">介绍</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#准备"><span class="nav-number">2.</span> <span class="nav-text">准备</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#1-安装NVM-详情"><span class="nav-number">2.1.</span> <span class="nav-text">1. 安装NVM(详情)</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2-安装Node-js"><span class="nav-number">2.2.</span> <span class="nav-text">2. 安装Node.js</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#基于Express创建WebAPP"><span class="nav-number">3.</span> <span class="nav-text">基于Express创建WebAPP</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#安装express"><span class="nav-number">3.1.</span> <span class="nav-text">安装express</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#创建一个新的WebApp"><span class="nav-number">3.2.</span> <span class="nav-text">创建一个新的WebApp</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#安装first-app的依赖包"><span class="nav-number">3.3.</span> <span class="nav-text">安装first-app的依赖包</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#运行first-app"><span class="nav-number">3.4.</span> <span class="nav-text">运行first-app</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#补充知识"><span class="nav-number">3.5.</span> <span class="nav-text">补充知识</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#项目结构"><span class="nav-number">4.</span> <span class="nav-text">项目结构</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#总览"><span class="nav-number">4.1.</span> <span class="nav-text">总览</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#为什么默认有好几个文件夹？"><span class="nav-number">4.1.1.</span> <span class="nav-text">为什么默认有好几个文件夹？</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#bin"><span class="nav-number">4.2.</span> <span class="nav-text">/bin</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#public"><span class="nav-number">4.3.</span> <span class="nav-text">/public</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#routes"><span class="nav-number">4.4.</span> <span class="nav-text">/routes</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#views"><span class="nav-number">4.5.</span> <span class="nav-text">/views</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#配置文件"><span class="nav-number">4.6.</span> <span class="nav-text">配置文件</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#主程序文件"><span class="nav-number">4.7.</span> <span class="nav-text">主程序文件</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#额外知识"><span class="nav-number">4.7.1.</span> <span class="nav-text">额外知识</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#bin-www文件不是必须的"><span class="nav-number">4.7.1.1.</span> <span class="nav-text">./bin/www文件不是必须的</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#为什么官网的示例和项目中的关键代码不一样？"><span class="nav-number">4.7.1.2.</span> <span class="nav-text">为什么官网的示例和项目中的关键代码不一样？</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#express官网的最小可行性代码"><span class="nav-number">4.7.1.2.1.</span> <span class="nav-text">express官网的最小可行性代码</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#app-js最小可行性代码"><span class="nav-number">4.7.1.2.2.</span> <span class="nav-text">app.js最小可行性代码</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#app-js能直接重命名"><span class="nav-number">4.7.1.2.3.</span> <span class="nav-text">app.js能直接重命名</span></a></li></ol></li></ol></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#认识路由"><span class="nav-number">5.</span> <span class="nav-text">认识路由</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#加载路由的逻辑处理模块"><span class="nav-number">5.1.</span> <span class="nav-text">加载路由的逻辑处理模块</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#设置路由和逻辑处理模块"><span class="nav-number">5.2.</span> <span class="nav-text">设置路由和逻辑处理模块</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#额外知识-1"><span class="nav-number">5.2.1.</span> <span class="nav-text">额外知识</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#路由和逻辑处理"><span class="nav-number">5.3.</span> <span class="nav-text">路由和逻辑处理</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#额外知识-2"><span class="nav-number">5.3.1.</span> <span class="nav-text">额外知识</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#配置执行项目的脚本"><span class="nav-number">6.</span> <span class="nav-text">配置执行项目的脚本</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#全局配置supervisor"><span class="nav-number">6.1.</span> <span class="nav-text">全局配置supervisor</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#在项目中配置supervisor脚本"><span class="nav-number">6.2.</span> <span class="nav-text">在项目中配置supervisor脚本</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#添加新的路由和页面"><span class="nav-number">7.</span> <span class="nav-text">添加新的路由和页面</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#新建并编写-routes-posts-js"><span class="nav-number">7.1.</span> <span class="nav-text">新建并编写./routes/posts.js</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#复制代码"><span class="nav-number">7.1.1.</span> <span class="nav-text">复制代码</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#修改注释"><span class="nav-number">7.1.2.</span> <span class="nav-text">修改注释</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#修改返回的页面"><span class="nav-number">7.1.3.</span> <span class="nav-text">修改返回的页面</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#新建并编写-views-posts-ejs的页面代码"><span class="nav-number">7.2.</span> <span class="nav-text">新建并编写./views/posts.ejs的页面代码</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#关联路由’-posts’和’-routes-posts-js’"><span class="nav-number">7.3.</span> <span class="nav-text">关联路由’/posts’和’/routes/posts.js’</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#思路"><span class="nav-number">7.3.1.</span> <span class="nav-text">思路</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#操作"><span class="nav-number">7.3.2.</span> <span class="nav-text">操作</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#如何让-routes-posts-js返回-views-posts-ejs这个页面"><span class="nav-number">7.4.</span> <span class="nav-text">如何让./routes/posts.js返回./views/posts.ejs这个页面</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#预览结果"><span class="nav-number">7.5.</span> <span class="nav-text">预览结果</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#模板引擎"><span class="nav-number">8.</span> <span class="nav-text">模板引擎</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#定制ejs模板"><span class="nav-number">9.</span> <span class="nav-text">定制ejs模板</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#延迟html渲染时机-客户端渲染数据"><span class="nav-number">10.</span> <span class="nav-text">延迟html渲染时机(客户端渲染数据)</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#服务器构建技术"><span class="nav-number">10.1.</span> <span class="nav-text">服务器构建技术</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#客户端渲染数据"><span class="nav-number">10.2.</span> <span class="nav-text">客户端渲染数据</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#渲染时机"><span class="nav-number">11.</span> <span class="nav-text">渲染时机</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#服务器渲染"><span class="nav-number">11.1.</span> <span class="nav-text">服务器渲染</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#客户端渲染"><span class="nav-number">11.2.</span> <span class="nav-text">客户端渲染</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#如何选择用客户端渲染还是服务器渲染技术"><span class="nav-number">11.3.</span> <span class="nav-text">如何选择用客户端渲染还是服务器渲染技术</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#选择服务器渲染"><span class="nav-number">11.3.1.</span> <span class="nav-text">选择服务器渲染</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#选择客户端渲染"><span class="nav-number">11.3.2.</span> <span class="nav-text">选择客户端渲染</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#客户端渲染和服务器渲染混合着用"><span class="nav-number">11.3.3.</span> <span class="nav-text">客户端渲染和服务器渲染混合着用</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#有必要考虑SEO"><span class="nav-number">11.4.</span> <span class="nav-text">有必要考虑SEO</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#路由归类"><span class="nav-number">12.</span> <span class="nav-text">路由归类</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#页面路由"><span class="nav-number">12.1.</span> <span class="nav-text">页面路由</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#数据路由"><span class="nav-number">12.2.</span> <span class="nav-text">数据路由</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#处理HTTP-POST请求"><span class="nav-number">13.</span> <span class="nav-text">处理HTTP POST请求</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#持久化存储-mongodb"><span class="nav-number">14.</span> <span class="nav-text">持久化存储 - mongodb</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#安装mongodb"><span class="nav-number">14.1.</span> <span class="nav-text">安装mongodb</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#添加mongoose"><span class="nav-number">14.2.</span> <span class="nav-text">添加mongoose</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#连接数据库"><span class="nav-number">14.3.</span> <span class="nav-text">连接数据库</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#定义模型-表"><span class="nav-number">14.4.</span> <span class="nav-text">定义模型 - 表</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#操作表"><span class="nav-number">14.5.</span> <span class="nav-text">操作表</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#增"><span class="nav-number">14.5.1.</span> <span class="nav-text">增</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#删"><span class="nav-number">14.5.2.</span> <span class="nav-text">删</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#查"><span class="nav-number">14.5.3.</span> <span class="nav-text">查</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#改"><span class="nav-number">14.5.4.</span> <span class="nav-text">改</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#存储数据"><span class="nav-number">15.</span> <span class="nav-text">存储数据</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#显示文章详情"><span class="nav-number">16.</span> <span class="nav-text">显示文章详情</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#处理markdown"><span class="nav-number">17.</span> <span class="nav-text">处理markdown</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#安装marked"><span class="nav-number">17.1.</span> <span class="nav-text">安装marked</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#利用marked将md内容转化成html内容"><span class="nav-number">17.2.</span> <span class="nav-text">利用marked将md内容转化成html内容</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#在first-app项目中引入marked模块"><span class="nav-number">17.3.</span> <span class="nav-text">在first-app项目中引入marked模块</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#设计页面跳转"><span class="nav-number">18.</span> <span class="nav-text">设计页面跳转</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#页面"><span class="nav-number">18.1.</span> <span class="nav-text">页面</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#API"><span class="nav-number">18.2.</span> <span class="nav-text">API</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#跳转设计"><span class="nav-number">18.3.</span> <span class="nav-text">跳转设计</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#在views-index-ejs中，引入bootstrap的巨幕样式："><span class="nav-number">18.3.1.</span> <span class="nav-text">在views/index.ejs中，引入bootstrap的巨幕样式：</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#在主页views-index-ejs增加巨幕样式："><span class="nav-number">18.3.2.</span> <span class="nav-text">在主页views/index.ejs增加巨幕样式：</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#改全局-lt-body-gt-的背景"><span class="nav-number">18.3.3.</span> <span class="nav-text">改全局 <body> 的背景</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#修改文章列表样式"><span class="nav-number">18.3.4.</span> <span class="nav-text">修改文章列表样式</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#在文章列表添加新建文章的按钮"><span class="nav-number">18.3.5.</span> <span class="nav-text">在文章列表添加新建文章的按钮</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#调整编辑页面布局"><span class="nav-number">18.3.6.</span> <span class="nav-text">调整编辑页面布局</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#调整文章显示页面布局"><span class="nav-number">18.3.7.</span> <span class="nav-text">调整文章显示页面布局</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#编辑文章"><span class="nav-number">19.</span> <span class="nav-text">编辑文章</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#页面-1"><span class="nav-number">19.1.</span> <span class="nav-text">页面</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#API-1"><span class="nav-number">19.2.</span> <span class="nav-text">API</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#添加页面路由处理逻辑"><span class="nav-number">19.3.</span> <span class="nav-text">添加页面路由处理逻辑</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#添加编辑按钮"><span class="nav-number">19.3.1.</span> <span class="nav-text">添加编辑按钮</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#增加访问编辑页面逻辑"><span class="nav-number">19.3.2.</span> <span class="nav-text">增加访问编辑页面逻辑</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#添加获取某个特定id的文章"><span class="nav-number">19.3.3.</span> <span class="nav-text">添加获取某个特定id的文章</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#添加编辑更新某个特定id的文章"><span class="nav-number">19.3.4.</span> <span class="nav-text">添加编辑更新某个特定id的文章</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#添加编辑页面"><span class="nav-number">19.3.5.</span> <span class="nav-text">添加编辑页面</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#页面模板"><span class="nav-number">20.</span> <span class="nav-text">页面模板</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#引入express-ejs-layouts"><span class="nav-number">20.1.</span> <span class="nav-text">引入express-ejs-layouts</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#安装"><span class="nav-number">20.1.1.</span> <span class="nav-text">安装</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#引入"><span class="nav-number">20.1.2.</span> <span class="nav-text">引入</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#使用"><span class="nav-number">20.1.3.</span> <span class="nav-text">使用</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#创建全局模板"><span class="nav-number">20.1.4.</span> <span class="nav-text">创建全局模板</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#修改其余页面"><span class="nav-number">20.1.5.</span> <span class="nav-text">修改其余页面</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#更好的API能力"><span class="nav-number">21.</span> <span class="nav-text">更好的API能力</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#API-2"><span class="nav-number">21.1.</span> <span class="nav-text">API</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#路由分类"><span class="nav-number">21.2.</span> <span class="nav-text">路由分类</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#API版本控制"><span class="nav-number">21.3.</span> <span class="nav-text">API版本控制</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#尽可能用http自身的方法来区分路由功能"><span class="nav-number">21.4.</span> <span class="nav-text">尽可能用http自身的方法来区分路由功能</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#避免使用动词来区分路由"><span class="nav-number">21.5.</span> <span class="nav-text">避免使用动词来区分路由</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#用资源ID而不是单词区分资源"><span class="nav-number">21.6.</span> <span class="nav-text">用资源ID而不是单词区分资源</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#最终的路由"><span class="nav-number">21.7.</span> <span class="nav-text">最终的路由</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#总结"><span class="nav-number">21.8.</span> <span class="nav-text">总结</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#更好的结果处理"><span class="nav-number">22.</span> <span class="nav-text">更好的结果处理</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#webapp不提供的能力"><span class="nav-number">22.1.</span> <span class="nav-text">webapp不提供的能力</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#修改数据返回的错误"><span class="nav-number">22.2.</span> <span class="nav-text">修改数据返回的错误</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#修改客户端（接受结果）的处理"><span class="nav-number">22.3.</span> <span class="nav-text">修改客户端（接受结果）的处理</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#总结-1"><span class="nav-number">22.4.</span> <span class="nav-text">总结</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#特别提醒"><span class="nav-number">22.5.</span> <span class="nav-text">特别提醒</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#停下来想一想"><span class="nav-number">23.</span> <span class="nav-text">停下来想一想</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#添加导航条"><span class="nav-number">24.</span> <span class="nav-text">添加导航条</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#添加账号系统"><span class="nav-number">25.</span> <span class="nav-text">添加账号系统</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#一次登录过程"><span class="nav-number">25.1.</span> <span class="nav-text">一次登录过程</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#一次请求过程"><span class="nav-number">25.2.</span> <span class="nav-text">一次请求过程</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#添加存储用户信息的表"><span class="nav-number">25.3.</span> <span class="nav-text">添加存储用户信息的表</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#定义一个全局的配置文件"><span class="nav-number">25.4.</span> <span class="nav-text">定义一个全局的配置文件</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#增加登录和注册页面"><span class="nav-number">25.5.</span> <span class="nav-text">增加登录和注册页面</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#添加新的页面路由处理"><span class="nav-number">25.5.1.</span> <span class="nav-text">添加新的页面路由处理</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#新建登录页面"><span class="nav-number">25.5.2.</span> <span class="nav-text">新建登录页面</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#新建注册页面"><span class="nav-number">25.5.3.</span> <span class="nav-text">新建注册页面</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#添加登录和注册的http请求处理"><span class="nav-number">25.6.</span> <span class="nav-text">添加登录和注册的http请求处理</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#引入模块"><span class="nav-number">25.6.1.</span> <span class="nav-text">引入模块</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#处理-api-v1-signup-请求"><span class="nav-number">25.6.2.</span> <span class="nav-text">处理 api/v1/signup 请求</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#处理-api-v1-signin-请求"><span class="nav-number">25.6.3.</span> <span class="nav-text">处理 api/v1/signin 请求</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#判断每一个http请求的cookie信息"><span class="nav-number">25.7.</span> <span class="nav-text">判断每一个http请求的cookie信息</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#新建一个检查登录状态的中间件"><span class="nav-number">25.7.1.</span> <span class="nav-text">新建一个检查登录状态的中间件</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#植入验证用户信息的中间件"><span class="nav-number">25.7.2.</span> <span class="nav-text">植入验证用户信息的中间件</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#根据用户信息弹性的构建导航条"><span class="nav-number">25.8.</span> <span class="nav-text">根据用户信息弹性的构建导航条</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#访问权限"><span class="nav-number">26.</span> <span class="nav-text">访问权限</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#给-post-添加作者-id"><span class="nav-number">26.1.</span> <span class="nav-text">给 post 添加作者 id</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#限制新建-post-的处理"><span class="nav-number">26.2.</span> <span class="nav-text">限制新建 post 的处理</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#显示编辑-post-的处理"><span class="nav-number">26.3.</span> <span class="nav-text">显示编辑 post 的处理</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#整理配置信息（改善）"><span class="nav-number">26.4.</span> <span class="nav-text">整理配置信息（改善）</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Kitematic"><span class="nav-number">27.</span> <span class="nav-text">Kitematic</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#下载Kitematic"><span class="nav-number">27.1.</span> <span class="nav-text">下载Kitematic</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#安装-1"><span class="nav-number">27.2.</span> <span class="nav-text">安装</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#安装mongodb-1"><span class="nav-number">27.3.</span> <span class="nav-text">安装mongodb</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#关于作者"><span class="nav-number">28.</span> <span class="nav-text">关于作者</span></a></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright" >
  
  &copy; 
  <span itemprop="copyrightYear">2017</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Katherine Chen</span>

  
</div>


  <div class="powered-by">由 <a class="theme-link" href="https://hexo.io">Hexo</a> 强力驱动</div>

  <span class="post-meta-divider">|</span>

  <div class="theme-info">主题 &mdash; <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next">NexT.Muse</a> v5.1.2</div>


        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>

  
  <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.2"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.2"></script>



  
  

  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.2"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.2"></script>


  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.2"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.2"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.2"></script>



  


  

    
      <script id="dsq-count-scr" src="https://chen-lingmin.disqus.com/count.js" async></script>
    

    
      <script type="text/javascript">
        var disqus_config = function () {
          this.page.url = 'http://yoursite.com/2017/11/18/WeApp/';
          this.page.identifier = '2017/11/18/WeApp/';
          this.page.title = 'WeApp';
        };
        var d = document, s = d.createElement('script');
        s.src = 'https://chen-lingmin.disqus.com/embed.js';
        s.setAttribute('data-timestamp', '' + +new Date());
        (d.head || d.body).appendChild(s);
      </script>
    

  




	





  










  





  

  

  

  

  

  

</body>
</html>
